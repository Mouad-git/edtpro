<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emploi du temps - Édition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* CSS DE BASE ET CONTRÔLES */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; } 
        :root { --primary: #1a2a6c; --primary-light: #2c3e9d; --border-color: #dde4ed; } 
        body { background-color: #fdfdfd; padding-top: 70px; user-select: none; } 
        nav { position: fixed; top: 0; left: 0; width: 100%; height: 60px; padding: 10px 20px; background: #fff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: flex; align-items: center; z-index: 1001; justify-content: space-between; } 
        .container { width: 100%; max-width: 98%; margin: 0 auto; padding: 15px; } 
        .hidden { display: none !important; }
        .control { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; height: 70px; margin-bottom: 20px; border-radius: 12px;  }
        
        /* ==================================================================== */
        /* === DÉBUT DE LA MODIFICATION DES STYLES POUR LES BOUTONS DE CONTRÔLE === */
        /* ==================================================================== */


        /* Nouveau style pour les boutons de contrôle */
        .btn-control {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 8px 18px; /* Ajustement du padding pour l'esthétique */
          gap: 10px; /* Espace entre l'icône et le texte */
          height: 45px; /* Hauteur fixe */
          border: none;
          background: #5e41de33; /* Fond violet très clair */
          border-radius: 20px; /* Bords arrondis */
          cursor: pointer;
          transition: background-color 0.3s ease; /* Transition douce pour le survol */
          box-shadow: none; /* On retire l'ancienne ombre */
        }

        .lable {
      margin-top: 1px;
      font-weight: 600;
      font-size: 15px;
      line-height: 22px;
      color: #5D41DE;
      letter-spacing: 1px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
        
        /* Style de l'icône à l'intérieur du bouton */
        .btn-control i {
            color: #5D41DE; /* S'assure que l'icône a la bonne couleur */
            font-size: 16px; /* Taille de l'icône */
        }
        
        /* Effet au survol du bouton */
        .btn-control:hover {
          background: #5e41de4d; /* Fond légèrement plus foncé au survol */
          transform: translateY(0); /* On annule l'ancien effet de translation */
        }



        /* ================================================================== */
        /* === FIN DE LA MODIFICATION DES STYLES POUR LES BOUTONS DE CONTRÔLE === */
        /* ================================================================== */

        .tab-container { position: relative; display: flex; align-items: flex-start; padding: 2px; background-color: #e0e0e0; border-radius: 9px; width: 264px; margin: 0 auto; height: 45px; } 
        .indicator { content: ""; width: 130px; height: 40px; background: white; position: absolute; top: 2px; left: 2px; z-index: 9; border-radius: 7px; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); box-shadow: 0 1px 5px rgba(0,0,0,0.1); } 
        .tab { width: 130px; height: 40px; position: absolute; z-index: 99; outline: none; opacity: 0; cursor: pointer; } 
        .tab_label { width: 130px; height: 40px; position: relative; z-index: 999; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: black; opacity: 0.8; cursor: pointer; transition: all 0.3s ease; font-weight: 500; } 
        .tab--1:checked ~ .indicator { left: 2px; } 
        .tab--2:checked ~ .indicator { left: calc(130px + 2px); } 
        .tab:checked + .tab_label { opacity: 1; font-weight: 600; color: var(--primary-light); }
        .table-container {
            max-height: calc(100vh - 210px); 
            overflow: auto; 
            border: 1px solid var(--border-color);
            -webkit-overflow-scrolling: touch;
            border-radius: 18px;
            padding: -1px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        #global-schedule thead {
          z-index: 300;
          border: 1px solid var(--border-color);
        }

        #global-schedule th {
          position: sticky !important;
          top: 0 !important;
          background-color: #f8f9fa;
          border: 1px solid var(--border-color);
          z-index: 300 !important;
          box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
          font-weight: 600;
        }

        /* Overlay de chargement PDF */
        #pdf-loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none; justify-content: center; align-items: center; flex-direction: column; color: white;
        }
        #pdf-loading-message { font-size: 1.2rem; padding: 20px; background: #333; border-radius: 10px; }
        
        /* Styles Calendrier Personnalisé */
        .custom-week-picker { position: relative; min-width: 250px; }
        #customWeekDisplay {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
            background-color: #fff;
            cursor: pointer;
            text-align: center;
            user-select: none;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        #customWeekDisplay img { height: 25px; width: auto; }
        @keyframes fadeInScaleUp { from { opacity: 0; transform: translateX(-50%) scale(0.95); } to { opacity: 1; transform: translateX(-50%) scale(1); } }
        #calendarPopup { display: none; position: absolute; top: calc(100% + 5px); left: 50%; transform: translateX(-50%); width: 320px; background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1200; padding: 15px; animation: fadeInScaleUp 0.2s ease-out; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .calendar-header button { background: none; border: none; font-size: 1rem; cursor: pointer; color: #555; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .calendar-header button:hover { background-color: #f0f4ff; color: #3498db; }
        .calendar-title { font-weight: 600; font-size: 1.1rem; color: #2c3e50; }
        .calendar-grid { width: 100%; border-collapse: collapse; text-align: center; }
        .calendar-grid th { font-size: 0.8rem; color: #95a5a6; padding-bottom: 10px; font-weight: 600; text-transform: uppercase; }
        .calendar-grid td { padding: 2px; }
        .calendar-day { width: 100%; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; font-size: 0.95rem; border: 1px solid transparent; }
        .calendar-day:hover { background-color: #f0f4ff; transform: scale(1.05); }
        .calendar-day.other-month { opacity: 0.4; }
        .calendar-day.disabled-day { color: #bdc3c7; background-color: #f9f9f9; cursor: not-allowed; }
        .calendar-day.disabled-day:hover { background-color: #f9f9f9; transform: none; }
        .calendar-day.today { border-color: #3498db; color: #3498db; font-weight: bold; }
        .calendar-day.selected-in-range { background-color: #eaf5ff; color: #2980b9; border-radius: 0; }
        .calendar-day.selected-start { background-color: #3498db; color: #fff; border-top-left-radius: 20px; border-bottom-left-radius: 20px; }
        .calendar-day.selected-end { background-color: #3498db; color: #fff; border-top-right-radius: 20px; border-bottom-right-radius: 20px; }
        
        /* Styles Tableau Global */
        #global-schedule { width: 100%; border-collapse: collapse; font-size: 14px; color: #333; table-layout: fixed; }
        #global-schedule thead { position: sticky !important; top: 0 !important; z-index: 300 !important; }
        #global-schedule th { text-align: center; font-weight: 600; color: #2c3e50; white-space: nowrap; font-size: 15px; padding: 12px 8px; background-color: #f8f9fa; border: 1px solid var(--border-color); }
        #global-schedule td { height: 40px; text-align: center; padding: 6px 8px; word-wrap: break-word; font-weight: 500; border: 1px solid #ecf0f1; }
        .name-cell { background: linear-gradient(to right, #2e55cc, #3927ae); color: white; font-weight: 600; vertical-align: middle; writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; padding: 8px 6px !important;  width: 5% !important;  min-width: 45px; font-size: 1rem; border-right: 2px solid #fff; }
        .type-cell { background-color: #fdfdfe; font-weight: 600; font-size: 11px; width: 100px; text-align: center; color: #555; border-right: 1px solid #ecf0f1; }
        #global-schedule .salle-row td { border-bottom: 3px solid #bdc3c7 !important; }
        .day-header-lundi, .day-header-mardi, .day-header-mercredi, .day-header-jeudi, .day-header-vendredi, .day-header-samedi, .slot-header, .day-lundi, .day-mardi, .day-mercredi, .day-jeudi, .day-vendredi, .day-samedi { background-color: transparent !important; }
        #global-schedule td:not(:empty):not(.type-cell) { background-color: #e8f5e9; }
        
        /* Styles Vue Détaillée */
        #specific-search-section .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: 15px; }
        #specific-search-section .card { border-radius: 12px; border: 1px solid var(--border-color); width: 100%; background: white; overflow: visible; min-height: 600px; }
        #specific-search-section .card-body { padding: 20px; }
        #specific-search-section .search-label { display: block; margin-bottom: 12px; font-weight: 600; color: var(--primary); font-size: 1.05rem; }
        #specific-search-section .autocomplete-container { position: relative; }
        #specific-search-section .autocomplete-input { width: 100%; padding: 14px 20px; border: 1px solid #d1d9e6; border-radius: 10px; font-size: 1rem; }
        #specific-search-section .autocomplete-list { position: absolute; top: calc(100% + 5px); left: 0; right: 0; max-height: 400px; overflow-y: auto; background: white; border: 1px solid #d1d9e6; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); z-index: 500; display: none; }
        #specific-search-section .autocomplete-item { padding: 12px 20px; cursor: pointer; }
        #specific-search-section .autocomplete-item:hover { background-color: #f0f7ff; }
        #specific-search-section .table-container { box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        #specific-search-section table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        #specific-search-section th, #specific-search-section td { border: 1px solid #ddd; background-color: #f8f9fa; padding: 8px; text-align: center; vertical-align: middle; }
        #specific-search-section th { background-color: #ffffff; font-weight: 600; color: #2c3e50; font-size: 15px; }
        #specific-search-section .day-header { font-weight: 600; background: linear-gradient(to right, #2e55cc, #3927ae); color: white; }
        #specific-search-section .info-type { background-color: #f0f7ff; font-weight: 600; }
        
        /* Styles Assistant Vocal */
        #voiceAssistantBtn {
          position: fixed;
          bottom: 30px;
          right: 30px;
          z-index: 1100;
        }

        .uiverse {
          --duration: 7s;
          --easing: linear;
          --c-color-1: rgba(255, 163, 26, 0.7);
          --c-color-2: #1a23ff;
          --c-color-3: #e21bda;
          --c-color-4: rgba(255, 232, 26, 0.7);
          --c-shadow: rgba(255, 223, 87, 0.5);
          --c-shadow-inset-top: rgba(255, 223, 52, 0.9);
          --c-shadow-inset-bottom: rgba(255, 250, 215, 0.8);
          --c-radial-inner: #ffd215;
          --c-radial-outer: #fff172;
          --c-color: #ffffff;
          -webkit-tap-highlight-color: transparent;
          -webkit-appearance: none;
          outline: none;
          position: relative;
          cursor: pointer;
          border: none;
          width: 60px; 
          height: 60px;
          border-radius: 50%;
          padding: 0;
          margin: 0;
          text-align: center;
          font-weight: 600;
          letter-spacing: 0.02em;
          line-height: 1.5;
          color: var(--c-color);
          background: radial-gradient(
            circle,
            var(--c-radial-inner),
            var(--c-radial-outer) 80%
          );
          box-shadow: 0 0 14px var(--c-shadow);
        }

        .uiverse:before {
          content: "";
          pointer-events: none;
          position: absolute;
          z-index: 3;
          left: 0;
          top: 0;
          right: 0;
          bottom: 0;
          border-radius: 50%;
          box-shadow:
            inset 0 3px 12px var(--c-shadow-inset-top),
            inset 0 -3px 4px var(--c-shadow-inset-bottom);
        }

        .uiverse .wrapper {
          -webkit-mask-image: -webkit-radial-gradient(white, black);
          overflow: hidden;
          border-radius: 50%; 
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .uiverse .wrapper span {
          display: inline-block;
          position: relative;
          z-index: 1;
          font-size: 24px;
          line-height: 0;
        }

        .uiverse:hover { --duration: 1400ms; }
        .uiverse.listening {
            --duration: 1s;
            box-shadow: 0 0 25px var(--c-color-2), 0 0 15px var(--c-shadow);
        }
        .uiverse.listening span i { animation: pulse-mic 1.5s infinite; }
        @keyframes pulse-mic {
            0% { transform: scale(1); color: #e74c3c; }
            50% { transform: scale(1.3); color: #1a23ff; }
            100% { transform: scale(1); color: #e74c3c; }
        }
        .uiverse .wrapper .circle {
          position: absolute;
          left: 0;
          top: 0;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          filter: blur(var(--blur, 8px));
          background: var(--background, transparent);
          transform: translate(var(--x, 0), var(--y, 0)) translateZ(0);
          animation: var(--animation, none) var(--duration) var(--easing) infinite;
        }
        .uiverse .wrapper .circle.circle-1,
        .uiverse .wrapper .circle.circle-9,
        .uiverse .wrapper .circle.circle-10 { --background: var(--c-color-4); }
        .uiverse .wrapper .circle.circle-3,
        .uiverse .wrapper .circle.circle-4 { --background: var(--c-color-2); --blur: 14px; }
        .uiverse .wrapper .circle.circle-5,
        .uiverse .wrapper .circle.circle-6 { --background: var(--c-color-3); --blur: 16px; }
        .uiverse .wrapper .circle.circle-2,
        .uiverse .wrapper .circle.circle-7,
        .uiverse .wrapper .circle.circle-8,
        .uiverse .wrapper .circle.circle-11,
        .uiverse .wrapper .circle.circle-12 { --background: var(--c-color-1); --blur: 12px; }
        .uiverse .wrapper .circle.circle-1 { --x: 0; --y: -40px; --animation: circle-1; }
        .uiverse .wrapper .circle.circle-2 { --x: 92px; --y: 8px; --animation: circle-2; }
        .uiverse .wrapper .circle.circle-3 { --x: -12px; --y: -12px; --animation: circle-3; }
        .uiverse .wrapper .circle.circle-4 { --x: 80px; --y: -12px; --animation: circle-4; }
        .uiverse .wrapper .circle.circle-5 { --x: 12px; --y: -4px; --animation: circle-5; }
        .uiverse .wrapper .circle.circle-6 { --x: 56px; --y: 16px; --animation: circle-6; }
        .uiverse .wrapper .circle.circle-7 { --x: 8px; --y: 28px; --animation: circle-7; }
        .uiverse .wrapper .circle.circle-8 { --x: 28px; --y: -4px; --animation: circle-8; }
        .uiverse .wrapper .circle.circle-9 { --x: 20px; --y: -12px; --animation: circle-9; }
        .uiverse .wrapper .circle.circle-10 { --x: 64px; --y: 16px; --animation: circle-10; }
        .uiverse .wrapper .circle.circle-11 { --x: 4px; --y: 4px; --animation: circle-11; }
        .uiverse .wrapper .circle.circle-12 { --blur: 14px; --x: 52px; --y: 4px; --animation: circle-12; }
        @keyframes circle-1 { 33% { transform: translate(0px, 16px) translateZ(0); } 66% { transform: translate(12px, 64px) translateZ(0); } }
        @keyframes circle-2 { 33% { transform: translate(80px, -10px) translateZ(0); } 66% { transform: translate(72px, -48px) translateZ(0); } }
        @keyframes circle-3 { 33% { transform: translate(20px, 12px) translateZ(0); } 66% { transform: translate(12px, 4px) translateZ(0); } }
        @keyframes circle-4 { 33% { transform: translate(76px, -12px) translateZ(0); } 66% { transform: translate(112px, -8px) translateZ(0); } }
        @keyframes circle-5 { 33% { transform: translate(84px, 28px) translateZ(0); } 66% { transform: translate(40px, -32px) translateZ(0); } }
        @keyframes circle-6 { 33% { transform: translate(28px, -16px) translateZ(0); } 66% { transform: translate(76px, -56px) translateZ(0); } }
        @keyframes circle-7 { 33% { transform: translate(8px, 28px) translateZ(0); } 66% { transform: translate(20px, -60px) translateZ(0); } }
        @keyframes circle-8 { 33% { transform: translate(32px, -4px) translateZ(0); } 66% { transform: translate(56px, -20px) translateZ(0); } }
        @keyframes circle-9 { 33% { transform: translate(20px, -12px) translateZ(0); } 66% { transform: translate(80px, -8px) translateZ(0); } }
        @keyframes circle-10 { 33% { transform: translate(68px, 20px) translateZ(0); } 66% { transform: translate(100px, 28px) translateZ(0); } }
        @keyframes circle-11 { 33% { transform: translate(4px, 4px) translateZ(0); } 66% { transform: translate(68px, 20px) translateZ(0); } }
        @keyframes circle-12 { 33% { transform: translate(56px, 0px) translateZ(0); } 66% { transform: translate(60px, -32px) translateZ(0); } }
        .assistant-status {
            position: fixed; bottom: 100px; right: 30px; background: rgba(0, 0, 0, 0.75);
            color: white; padding: 10px 20px; border-radius: 20px; z-index: 1099;
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .assistant-status.visible { opacity: 1; }
        nav a { text-decoration: none; color: #333; padding: 8px 16px; border-radius: 8px; transition: background-color 0.3s, color 0.3s; }
        nav a:hover { background-color: #f0f4ff; color: #1d4ed8; font-weight: 600; }
        nav a.active { background-color: #f0f4ff; color: #1d4ed8; font-weight: 600; }
        .nav-links { display: flex; align-items: center; gap: 10px; }
        .profile-menu-container { position: relative; }
        .profile-button {
            display: flex; align-items: center; justify-content: center; text-decoration: none;
            width: 40px; height: 40px; border-radius: 50%; background-color: #e0eaff;
            color: #1d4ed8; border: 1px solid #e0eaff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .profile-dropdown {
            display: none; position: absolute; top: calc(100% + 12px); right: 0;
            width: 280px; background-color: white; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 1010; overflow: hidden;
            transform-origin: top right; animation: scale-up-and-fade-in 0.2s ease-out;
        }
        .profile-dropdown.show { display: block; }
        @keyframes scale-up-and-fade-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .dropdown-profile-header { display: flex; align-items: center; gap: 12px; padding: 16px; border-bottom: 1px solid #f3f4f6; }
        .profile-pic {
            width: 48px; height: 48px; border-radius: 50%; background-color: #f3f4f6;
            display: flex; align-items: center; justify-content: center; font-size: 24px; color: #6b7280;
        }
        .profile-info strong { display: block; font-size: 1rem; font-weight: 600; color: #111827; }
        .profile-info small { font-size: 0.875rem; color: #6b7280; }
        .dropdown-menu-list { list-style: none; padding: 8px; margin: 0; }
        .dropdown-link {
            display: flex; align-items: center; width: 100%; padding: 10px 12px;
            border-radius: 8px; text-decoration: none; color: #374151;
            font-weight: 500; transition: background-color 0.2s, color 0.2s;
        }
        .dropdown-link:hover { background-color: #f3f4f6; }
        .dropdown-link .icon { width: 32px; font-size: 16px; color: #6b7280; }
        .dropdown-link .text { flex-grow: 1; }
        .dropdown-link .chevron { font-size: 12px; color: #9ca3af; }
        .dropdown-divider { margin: 0 8px; border: none; border-top: 1px solid #f3f4f6; }
        .dropdown-link.logout { margin: 8px; width: calc(100% - 16px); color: #ef4444; }
        .dropdown-link.logout .icon { color: #ef4444; }
        .dropdown-link.logout:hover { background-color: #fee2e2; }
        
        @media print {
            body { padding-top: 0; background-color: #fff; }
            nav, .control, #specific-search-section, #pdf-loading-overlay { display: none !important; }
            .container, .main-content { padding: 0; margin: 0; width: 100%; max-width: 100%; }
            .table-container { box-shadow: none; border: none; overflow: visible; }
            #global-schedule { font-size: 8pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #global-schedule th, #global-schedule td { padding: 3px; }
            #global-view-section { display: block !important; }
            @page { size: A3 landscape; margin: 0.5cm; }
        }

    </style>
</head>
<body>
    <div id="pdf-loading-overlay">
        <div id="pdf-loading-message">Génération du PDF...</div>
    </div>

    <nav>
        <img src="assets/images/logo_edtpro.png" style="height: 80px; width: auto;" id="logo" alt="Logo">
        <div class="nav-links">
            <a href="admin.html" id="nav-admin">Emploi globale</a>
            <a href="edition.html" id="nav-edition">Edition</a>
            <a href="avancement.html" id="nav-avancement">Avancement</a>
            <div class="profile-menu-container" id="profile-menu-container">
              <button id="profile-button" class="profile-button">
                <span id="profile-initials">--</span>
              </button>
              <div id="profile-dropdown" class="profile-dropdown">
                <div class="dropdown-profile-header">
                    <div class="profile-pic"><i class="fas fa-user"></i></div>
                    <div class="profile-info">
                        <strong id="dropdown-user-name">Chargement...</strong>
                        <small id="dropdown-user-email">...</small>
                    </div>
                </div>
                <ul class="dropdown-menu-list">
                    <li>
                        <a href="profile.html" class="dropdown-link">
                            <i class="fas fa-user-edit icon"></i>
                            <span class="text">Mon Profil</span>
                            <i class="fas fa-chevron-right chevron"></i>
                        </a>
                    </li>
                </ul>
                <hr class="dropdown-divider">
                <a href="../api/auth/logout.php" class="dropdown-link logout">
                    <i class="fas fa-sign-out-alt icon"></i>
                    <span class="text">Déconnexion</span>
                </a>
              </div>
        </div>
    </nav>

    <div class="container">
        <div class="control">
            <div class="tab-control">
                <div class="tab-container">
                    <input type="radio" name="tab" id="tab1" class="tab tab--1" checked />
                    <label for="tab1" class="tab_label">Formateur</label>
                    <input type="radio" name="tab" id="tab2" class="tab tab--2" />
                    <label for="tab2" class="tab_label">Groupe</label>
                    <div class="indicator"></div>
                </div>
            </div>
            
            <div class="week-selection">
                <div class="custom-week-picker">
                    <div id="customWeekDisplay">
                        <img src="https://cdn-icons-png.flaticon.com/512/12887/12887924.png" alt="">
                        <span id="weekDisplayText"></span>
                    </div>
                    <div id="calendarPopup">
                        <div class="calendar-header">
                            <button id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button>
                            <span id="calendarTitle"></span>
                            <button id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <table class="calendar-grid">
                            <thead><tr><th>L</th><th>M</th><th>M</th><th>J</th><th>V</th><th>S</th><th>D</th></tr></thead>
                            <tbody id="calendarBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="view-controls" style="display: flex; gap: 10px;">
                <button id="view-toggle-btn" class="btn-control"><i class="fas fa-filter"></i><span class="lable">Vue Détaillée</span></button>
                
                <div id="global-view-buttons" style="display: flex; gap: 10px;">
                    <button id="print-global-btn" class="btn-control" style="display: none;"><i class="fas fa-print"></i> Imprimer</button>
                    <button id="download-global-pdf-btn" class="btn-control"><i class="fas fa-file-pdf"></i> PDF Global</button>
                </div>

                <button id="download-teacher-pdf" class="btn-control hidden"><i class="fas fa-file-pdf"></i> PDF Formateur</button>
                <button id="download-group-pdf" class="btn-control hidden"><i class="fas fa-file-pdf"></i> PDF Groupe</button>
            </div>
        </div>

        <div class="main-content">
            <div id="global-view-section">
                <div class="table-container" style="margin: 0 -20px;">
                    <table id="global-schedule"></table>
                </div>
            </div>
            <div id="specific-search-section" class="hidden">
                 <div id="formateur-section">
                    <div class="main-grid">
                        <div class="sidebar">
                            <div class="card">
                                <div class="card-body">
                                    <label class="search-label">Rechercher un formateur</label>
                                    <div class="autocomplete-container">
                                        <input type="text" id="teacher-search" class="autocomplete-input" placeholder="Entrez le nom...">
                                        <div class="autocomplete-list" id="teacher-autocomplete-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content">
                            <div class="table-container">
                                <table id="teacher-schedule-table"></table>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="groupe-section" class="hidden">
                     <div class="main-grid">
                        <div class="sidebar">
                            <div class="card">
                                <div class="card-body">
                                    <label class="search-label">Rechercher un groupe</label>
                                    <div class="autocomplete-container">
                                        <input type="text" id="group-search" class="autocomplete-input" placeholder="Entrez le nom...">
                                        <div class="autocomplete-list" id="group-autocomplete-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content">
                            <div class="table-container">
                                <table id="group-schedule-table"></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="uiverse" id="voiceAssistantBtn" title="Activer l'assistant vocal">
        <div class="wrapper">
          <span><i class="fas fa-microphone"></i></span>
          <div class="circle circle-12"></div><div class="circle circle-11"></div><div class="circle circle-10"></div>
          <div class="circle circle-9"></div><div class="circle circle-8"></div><div class="circle circle-7"></div>
          <div class="circle circle-6"></div><div class="circle circle-5"></div><div class="circle circle-4"></div>
          <div class="circle circle-3"></div><div class="circle circle-2"></div><div class="circle circle-1"></div>
        </div>
    </button>
    <div class="assistant-status" id="assistantStatus"></div>

    <script>
        // Le code JavaScript reste inchangé car les IDs des boutons
        // et leur fonctionnement logique n'ont pas été modifiés.
        // --- VARIABLES GLOBALES ---
    let historique = [];
    let selectedWeekIndex = -1; // Initialiser à -1 pour indiquer qu'aucune semaine n'est sélectionnée
    let currentView = 'global';
    let currentMode = 'formateur';
    let selectedTeacher = '', selectedGroup = '';
    let teachers = [], groups = new Set();
    const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
    const slots = ['S1', 'S2', 'S3', 'S4'];
    
    // Variables pour le calendrier
    let selectedDate = new Date();
    let calendarCurrentDate = new Date();
    let currentWeekValue = ''; 
    
    function getCacheBuster() { return 't=' + new Date().getTime(); }

    function loadData() {
    // On remplace simplement l'URL
    fetch(`../api/data/get_all_timetables.php`)
        .then(response => response.json())
        .then(data => {
            // Le reste de votre code est identique car la structure de données est la même !
            historique = data.sort((a, b) => (a.semaine || "").localeCompare(b.semaine || ""));
            initializeApp();
        }).catch(error => {
            console.error('Erreur de chargement de l\'historique:', error);
            historique = []; // On initialise avec un tableau vide en cas d'erreur
            initializeApp();
        });
}
    function initializeApp() {
        if (historique.length === 0) {
            console.warn("L'historique des semaines est vide. Le calendrier pourrait ne pas fonctionner comme prévu.");
        }
        setupEventListeners();
        setupCustomCalendar();
        updateWeekSelection(new Date()); 
        updateButtonVisibility(); // MODIFICATION : Mettre à jour l'état initial des boutons
    }
    
    // --- GESTIONNAIRES D'ÉVÉNEMENTS ---
    function setupEventListeners() {
        document.getElementById('view-toggle-btn').addEventListener('click', toggleView);
        document.getElementById('print-global-btn').addEventListener('click', () => window.print());
        document.getElementById('tab1').addEventListener('change', () => switchMode('formateur'));
        document.getElementById('tab2').addEventListener('change', () => switchMode('groupe'));
        setupAutocomplete('teacher');
        setupAutocomplete('group');
        document.getElementById('download-teacher-pdf').addEventListener('click', () => downloadPDF('teacher'));
        document.getElementById('download-group-pdf').addEventListener('click', () => downloadPDF('group'));
        document.getElementById('download-global-pdf-btn').addEventListener('click', () => downloadGlobalPDF(currentMode));
    }

    // MODIFICATION : Nouvelle fonction pour gérer la visibilité des boutons
    function updateButtonVisibility() {
        const isGlobalView = currentView === 'global';
        const isFormateurMode = currentMode === 'formateur';

        // Afficher/masquer le groupe de boutons de la vue globale
        document.getElementById('global-view-buttons').style.display = isGlobalView ? 'flex' : 'none';

        // Afficher/masquer les boutons PDF spécifiques à la vue détaillée
        document.getElementById('download-teacher-pdf').classList.toggle('hidden', !(!isGlobalView && isFormateurMode));
        document.getElementById('download-group-pdf').classList.toggle('hidden', !(!isGlobalView && !isFormateurMode));

        // Mettre à jour le texte du bouton de basculement de vue
        const toggleBtn = document.getElementById('view-toggle-btn');
        if (isGlobalView) {
            toggleBtn.innerHTML = '<i class="fas fa-filter"></i> Vue Détaillée';
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-globe-americas"></i> Vue Globale';
        }
    }


    function toggleView() {
        currentView = (currentView === 'global') ? 'specific' : 'global';
        document.getElementById('global-view-section').classList.toggle('hidden');
        document.getElementById('specific-search-section').classList.toggle('hidden');
        
        updateButtonVisibility(); 

        if (currentView === 'specific') {
            displayDefaultSpecificView();
        } else {
            updateAllViews();
        }
    }

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('formateur-section').classList.toggle('hidden', mode !== 'formateur');
        document.getElementById('groupe-section').classList.toggle('hidden', mode !== 'groupe');
        
        updateButtonVisibility(); 

        if (currentView === 'global') {
            displayGlobalSchedule();
        } else {
            displayDefaultSpecificView();
        }
    }

    // --- MISE À JOUR CENTRALE ---
    function updateAllViews() {
        updateDataForWeek();
        if (currentView === 'global') {
            displayGlobalSchedule();
        } else {
            updateAutocompleteLists();
            if (currentMode === 'formateur' && selectedTeacher) displayTeacherSchedule(selectedTeacher);
            if (currentMode === 'groupe' && selectedGroup) displayGroupSchedule(selectedGroup);
        }
    }

    function updateDataForWeek() {
        if (selectedWeekIndex === -1) {
            teachers = [];
            groups.clear();
            return;
        }

        const emploi = historique[selectedWeekIndex]?.emploiDuTemps;
        if (!emploi) {
            teachers = [];
            groups.clear();
            return;
        }
        
        teachers = Object.keys(emploi).sort();
        groups.clear();
        for (const teacher in emploi) {
            for (const day in emploi[teacher]) {
                for (const slot in emploi[teacher][day]) {
                    const groupString = emploi[teacher][day][slot]?.groupe;
                    if (groupString) {
                        groupString.split(' ').forEach(g => g.trim() && groups.add(g.trim()));
                    }
                }
            }
        }
    }

    // --- SECTION CALENDRIER ---
    function setupCustomCalendar() {
        const display = document.getElementById('customWeekDisplay');
        const popup = document.getElementById('calendarPopup');
        const prevBtn = document.getElementById('prevMonthBtn');
        const nextBtn = document.getElementById('nextMonthBtn');

        display.addEventListener('click', () => {
            const isVisible = popup.style.display === 'block';
            popup.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                calendarCurrentDate = new Date(selectedDate);
                generateCalendar(calendarCurrentDate);
            }
        });

        prevBtn.addEventListener('click', () => {
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
            generateCalendar(calendarCurrentDate);
        });

        nextBtn.addEventListener('click', () => {
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
            generateCalendar(calendarCurrentDate);
        });
        
        document.addEventListener('click', (e) => {
            if (!display.closest('.custom-week-picker') && !popup.closest('.custom-week-picker')) {
                popup.style.display = 'none';
            }
        });
    }

    function generateCalendar(date) {
        const calendarBody = document.getElementById('calendarBody');
        const calendarTitle = document.getElementById('calendarTitle');
        
        calendarBody.innerHTML = '';
        const month = date.getMonth();
        const year = date.getFullYear();

        const monthName = date.toLocaleDateString('fr-FR', { month: 'long' });
        calendarTitle.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dateOffset = (firstDayOfMonth.getDay() + 6) % 7; 

        const selectedWeekInfo = getWeekInfo(selectedDate);
        const { startOfWeek, endOfWeek } = selectedWeekInfo;

        let currentDay = 1;
        for (let i = 0; i < 6; i++) {
            const row = document.createElement('tr');
            for (let j = 0; j < 7; j++) {
                const cell = document.createElement('td');
                if (i === 0 && j < dateOffset) {
                } else if (currentDay > daysInMonth) {
                } else {
                    const cellDate = new Date(year, month, currentDay);
                    cellDate.setHours(0,0,0,0);
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.textContent = currentDay;

                    const today = new Date();
                    today.setHours(0,0,0,0);
                    if (cellDate.getTime() === today.getTime()) {
                        dayDiv.classList.add('today');
                    }
                    
                    if (cellDate.getMonth() === 7) { 
                        dayDiv.classList.add('disabled-day');
                    } else {
                        dayDiv.onclick = () => {
                           updateWeekSelection(cellDate);
                           document.getElementById('calendarPopup').style.display = 'none';
                        };
                    }
                    
                    if (cellDate >= startOfWeek && cellDate <= endOfWeek) {
                        if (cellDate.getTime() === startOfWeek.getTime()) {
                            dayDiv.classList.add('selected-start');
                        } else if (cellDate.getTime() === endOfWeek.getTime()) {
                            dayDiv.classList.add('selected-end');
                        } else {
                            dayDiv.classList.add('selected-in-range');
                        }
                    }
                    cell.appendChild(dayDiv);
                    currentDay++;
                }
                row.appendChild(cell);
            }
            calendarBody.appendChild(row);
            if (currentDay > daysInMonth) break;
        }
    }

    function updateWeekSelection(date) {
        selectedDate = date;
        const weekInfo = getWeekInfo(date);
        
        document.getElementById('weekDisplayText').innerHTML = `<strong>S${weekInfo.weekNumber}</strong> <span style="font-size:0.9em; color: #555;">(${weekInfo.startOfWeek.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })} - ${weekInfo.endOfWeek.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })})</span>`;
        
        if (weekInfo.weekValue !== currentWeekValue) {
            currentWeekValue = weekInfo.weekValue;
            selectedWeekIndex = historique.findIndex(w => w.semaine === currentWeekValue);
            updateAllViews();
        }
        generateCalendar(calendarCurrentDate);
    }

    function getSchoolYear(date) {
        return (date.getMonth() < 8) ? date.getFullYear() - 1 : date.getFullYear();
    }

    function getWeekInfo(date) {
        const schoolYear = getSchoolYear(date);
        let firstMonday = new Date(schoolYear, 8, 1);
        firstMonday.setDate(firstMonday.getDate() + (8 - firstMonday.getDay()) % 7);
        if (firstMonday.getDate() > 7) firstMonday.setDate(firstMonday.getDate() - 7);
        
        let startOfWeek = new Date(date);
        startOfWeek.setDate(date.getDate() - (date.getDay() + 6) % 7);
        startOfWeek.setHours(0, 0, 0, 0);
        firstMonday.setHours(0, 0, 0, 0);
        
        let weekNumber = 1;
        if (startOfWeek >= firstMonday) {
            weekNumber = Math.floor((startOfWeek - firstMonday) / (1000 * 60 * 60 * 24 * 7)) + 1;
        }

        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        return {
            schoolYear, weekNumber, startOfWeek, endOfWeek,
            weekValue: `${schoolYear}-W${weekNumber}`
        };
    }

    // --- FONCTIONS DE RENDU ---
    function displayGlobalSchedule() {
        const table = document.getElementById('global-schedule');
        
        if (selectedWeekIndex === -1) {
            table.innerHTML = "<thead><tr><th>Aucune donnée pour cette semaine. Sélectionnez une autre semaine.</th></tr></thead>";
            return;
        }

        const emploi = historique[selectedWeekIndex]?.emploiDuTemps;
        if (!emploi) { table.innerHTML = "<thead><tr><th>Aucune donnée pour cette semaine</th></tr></thead>"; return; }
        
        let headerHtml = '<thead><tr><th rowspan="2" colspan="2"></th>';
        days.forEach((day, index) => headerHtml += `<th colspan="4">${day}</th>`);
        headerHtml += '</tr><tr>';
        days.forEach(() => slots.forEach(slot => headerHtml += `<th>${slot}</th>`));
        headerHtml += '</tr></thead>';

        let bodyHtml = '<tbody>';
        const items = (currentMode === 'formateur') ? teachers : Array.from(groups).sort();
        const infoTypes = (currentMode === 'formateur') ? ['Groupe', 'Module', 'Espace'] : ['Formateur', 'Module', 'Espace'];
        
        items.forEach(item => {
            const sessionColors = {};
            days.forEach(day => {
                slots.forEach(slot => {
                    const key = `${day}-${slot}`;
                    let salle = '';
                    if (currentMode === 'formateur') {
                        salle = emploi[item]?.[day]?.[slot]?.salle || '';
                    } else {
                        salle = findGroupData(emploi, item, day, slot, 'salle') || '';
                    }
                    if (salle.toUpperCase() === 'TEAMS') sessionColors[key] = '#E6E6FA';
                    else if (salle.toUpperCase() === 'EFM RÉG') sessionColors[key] = '#ADD8E6';
                });
            });

            for (let i = 0; i < infoTypes.length; i++) {
                bodyHtml += `<tr ${i === infoTypes.length - 1 ? 'class="salle-row"' : ''}>`;
                if (i === 0) bodyHtml += `<td rowspan="3" class="name-cell">${item}</td>`;
                bodyHtml += `<td class="type-cell">${infoTypes[i]}</td>`;
                
                days.forEach(day => {
                    slots.forEach(slot => {
                        let data = '';
                        const propertyKey = infoTypes[i].toLowerCase() === 'espace' ? 'salle' : infoTypes[i].toLowerCase();
                        if (currentMode === 'formateur') {
                            data = emploi[item]?.[day]?.[slot]?.[propertyKey] || '';
                        } else {
                            const session = findGroupData(emploi, item, day, slot, 'all');
                            data = (propertyKey === 'formateur' ? session.formateur : session[propertyKey]) || '';
                        }
                        const key = `${day}-${slot}`;
                        const backgroundColor = sessionColors[key] || '';
                        const style = backgroundColor ? `background-color: ${backgroundColor};` : '';
                        bodyHtml += `<td style="${style}">${data}</td>`;
                    });
                });
                bodyHtml += `</tr>`;
            }
        });
        table.innerHTML = headerHtml + bodyHtml + '</tbody>';
    }
    
    function findGroupData(emploi, group, day, slot, infoType) {
        for (const teacher in emploi) {
            if (Object.prototype.hasOwnProperty.call(emploi, teacher)) {
                const session = emploi[teacher]?.[day]?.[slot];
                if (session && typeof session.groupe === 'string' && session.groupe) {
                    const sessionGroups = session.groupe.trim().split(' ').filter(g => g);
                    if (sessionGroups.includes(group)) {
                        return infoType === 'all' ? { formateur: teacher, ...session } : (infoType === 'teacher' ? teacher : (session[infoType] || ''));
                    }
                }
            }
        }
        return infoType === 'all' ? {} : '';
    }
    
    function displayTeacherSchedule(teacher) {
        const table = document.getElementById('teacher-schedule-table');
        if (selectedWeekIndex === -1) { table.innerHTML = '<tbody><tr><td colspan="5">Aucune donnée disponible.</td></tr></tbody>'; return; }
        const emploi = historique[selectedWeekIndex]?.emploiDuTemps?.[teacher];
        if (!emploi) { table.innerHTML = '<tbody><tr><td colspan="5">Aucun emploi du temps disponible.</td></tr></tbody>'; return; }

        let html = `<thead><tr><th>Jour</th><th>Info</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th></tr></thead><tbody>`;
        days.forEach(day => {
            const dayData = emploi[day] || {};
            html += `<tr><td rowspan="3" class="day-header">${day}</td><td class="info-type">Groupe</td><td>${dayData.S1?.groupe || '-'}</td><td>${dayData.S2?.groupe || '-'}</td><td>${dayData.S3?.groupe || '-'}</td><td>${dayData.S4?.groupe || '-'}</td></tr>
                     <tr><td class="info-type">Module</td><td>${dayData.S1?.module || '-'}</td><td>${dayData.S2?.module || '-'}</td><td>${dayData.S3?.module || '-'}</td><td>${dayData.S4?.module || '-'}</td></tr>
                     <tr><td class="info-type">Espace</td><td>${dayData.S1?.salle || '-'}</td><td>${dayData.S2?.salle || '-'}</td><td>${dayData.S3?.salle || '-'}</td><td>${dayData.S4?.salle || '-'}</td></tr>`;
        });
        table.innerHTML = html + '</tbody>';
    }

    function displayGroupSchedule(group) {
        const table = document.getElementById('group-schedule-table');
        if (selectedWeekIndex === -1) { table.innerHTML = '<tbody><tr><td colspan="5">Aucune donnée disponible.</td></tr></tbody>'; return; }
        const emploi = historique[selectedWeekIndex]?.emploiDuTemps;
        if (!emploi) { table.innerHTML = '<tbody><tr><td colspan="5">Aucune donnée disponible.</td></tr></tbody>'; return; }

        let html = `<thead><tr><th>Jour</th><th>Info</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th></tr></thead><tbody>`;
        days.forEach(day => {
            html += `<tr><td rowspan="3" class="day-header">${day}</td><td class="info-type">Formateur</td><td>${findGroupData(emploi, group, day, 'S1', 'teacher') || '-'}</td><td>${findGroupData(emploi, group, day, 'S2', 'teacher') || '-'}</td><td>${findGroupData(emploi, group, day, 'S3', 'teacher') || '-'}</td><td>${findGroupData(emploi, group, day, 'S4', 'teacher') || '-'}</td></tr>
                     <tr><td class="info-type">Module</td><td>${findGroupData(emploi, group, day, 'S1', 'module') || '-'}</td><td>${findGroupData(emploi, group, day, 'S2', 'module') || '-'}</td><td>${findGroupData(emploi, group, day, 'S3', 'module') || '-'}</td><td>${findGroupData(emploi, group, day, 'S4', 'module') || '-'}</td></tr>
                     <tr><td class="info-type">Espace</td><td>${findGroupData(emploi, group, day, 'S1', 'salle') || '-'}</td><td>${findGroupData(emploi, group, day, 'S2', 'salle') || '-'}</td><td>${findGroupData(emploi, group, day, 'S3', 'salle') || '-'}</td><td>${findGroupData(emploi, group, day, 'S4', 'salle') || '-'}</td></tr>`;
        });
        table.innerHTML = html + '</tbody>';
    }

    function setupAutocomplete(type) {
        const input = document.getElementById(`${type}-search`);
        const list = document.getElementById(`${type}-autocomplete-list`);
        input.addEventListener('input', () => {
            list.style.display = 'block';
            const term = input.value.toLowerCase();
            Array.from(list.children).forEach(item => item.style.display = item.textContent.toLowerCase().includes(term) ? 'block' : 'none');
        });
        document.addEventListener('click', e => { if (!e.target.closest('.autocomplete-container')) list.style.display = 'none'; });
    }

    function updateAutocompleteLists() {
        populateAutocomplete('teacher', teachers);
        populateAutocomplete('group', Array.from(groups).sort());
    }

    function populateAutocomplete(type, dataArray) {
        const list = document.getElementById(`${type}-autocomplete-list`);
        list.innerHTML = '';
        dataArray.forEach(itemValue => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.textContent = itemValue;
            item.onclick = () => {
                document.getElementById(`${type}-search`).value = itemValue;
                list.style.display = 'none';
                if (type === 'teacher') { selectedTeacher = itemValue; displayTeacherSchedule(itemValue); } 
                else { selectedGroup = itemValue; displayGroupSchedule(itemValue); }
            };
            list.appendChild(item);
        });
    }

    function loadImageAsBase64(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const dataURL = canvas.toDataURL('image/png');
                resolve(dataURL);
            };
            img.onerror = (error) => reject(new Error('Failed to load image: ' + url));
            img.src = url;
        });
    }

    // --- FONCTIONS PDF ---
    async function downloadGlobalPDF(mode) {
    const loadingOverlay = document.getElementById('pdf-loading-overlay');
    const loadingMessage = document.getElementById('pdf-loading-message');
    const weekData = historique[selectedWeekIndex];
    const emploi = weekData?.emploiDuTemps;

    if (!emploi || Object.keys(emploi).length === 0) {
        alert("Aucune donnée d'emploi du temps à exporter pour cette semaine.");
        return;
    }

    loadingMessage.textContent = `Génération du PDF Global (${mode})...`;
    loadingOverlay.style.display = 'flex';

    try {
        const logoBase64 = await loadImageAsBase64('assets/images/logo_ofppt.png');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a2' });
            const M = (mode === 'formateur') ? 'FORMATEUR' : 'GROUPE';

        doc.addImage(logoBase64, 'PNG', 15, 10, 30, 30);
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text(`EMPLOI GLOBAL ${M}S`, doc.internal.pageSize.width / 2, 22, { align: 'center' });
        const { dateDebut, dateFin } = getDatesForISOWeek(weekData.semaine);
        const startDate = formatDate(dateDebut);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'normal');
        doc.text(`A PARTIR DU : ${startDate}`, 265, 38);

        const timeHeaders = ['08h30 11h00', '11h00 13h30', '13h30 16h00', '16h00 18h30'];
        const head = [
            [
                { content: 'ÉMARGEMENT', rowSpan: 2, styles: { halign: 'center', fontStyle: 'bold', fillColor: [255, 255, 255], textColor: [0,0,0] } },
                { content: `${M}`, rowSpan: 2, styles: { halign: 'center', fontStyle: 'bold', fillColor: [255, 255, 255], textColor: [0,0,0] } },
                { content: 'TYPE', rowSpan: 2, styles: { halign: 'center', fontStyle: 'bold', fillColor: [255, 255, 255], textColor: [0,0,0] } }
            ],
            []
        ];
        
        days.forEach(day => {
            head[0].push({ content: day.toUpperCase(), colSpan: 4, styles: { halign: 'center', fillColor: '#fff', textColor: [0, 0, 0], fontStyle: 'bold' } });
            timeHeaders.forEach(time => head[1].push({ content: time, styles: { halign: 'center', fillColor: '#fff', textColor: [0, 0, 0] } }));
        });
        
        const body = [];
        const items = (mode === 'formateur') ? teachers : Array.from(groups).sort();
        const slots = ['S1', 'S2', 'S3', 'S4'];
        const infoTypes = (mode === 'formateur') ? ['Groupe', 'Module', 'Salle'] : ['Formateur', 'Module', 'Salle'];

        items.forEach(item => {
            const rowGroup = [ [], [], [] ];
            rowGroup[0].unshift({ content: '', rowSpan: 3 });
            rowGroup[0].push({ content: item, rowSpan: 3, styles: { valign: 'middle', fontStyle: 'bold' } });
            rowGroup[0].push({ content: infoTypes[0].toUpperCase(), styles: { fontStyle: 'bold' } });
            rowGroup[1].push({ content: infoTypes[1].toUpperCase() });
            rowGroup[2].push({ content: infoTypes[2].toUpperCase() });

            days.forEach(day => {
                slots.forEach(slot => {
                    let sessionData = {};
                    if (mode === 'formateur') sessionData = emploi[item]?.[day]?.[slot] || {};
                    else sessionData = findGroupData(emploi, item, day, slot, 'all') || {};
                    const cleanContent = (data) => (typeof data === 'object' && data !== null) ? '' : (data || '');
                    const content1 = (mode === 'formateur') ? cleanContent(sessionData.groupe) : cleanContent(sessionData.formateur);
                    const content2 = cleanContent(sessionData.module);
                    const content3 = cleanContent(sessionData.salle);
                    const style = content1 ? { fillColor: [240, 240, 0] } : {}; 
                    rowGroup[0].push({ content: content1, styles: style });
                    rowGroup[1].push({ content: content2, styles: style });
                    rowGroup[2].push({ content: content3, styles: style });
                });
            });
            body.push(...rowGroup);
        });

        doc.autoTable({
            startY: 45, head: head, body: body, theme: 'grid',
            styles: { fontSize: 10, cellPadding: 2, halign: 'center', valign: 'middle', lineWidth: 0.1, lineColor: [0, 0, 0] },
            headStyles: { lineWidth: 0.1, lineColor: [0, 0, 0], fontStyle: 'bold' },
            columnStyles: { 0: { cellWidth: 32 }, 1: { cellWidth: 28 }, 2: { cellWidth: 28, fontStyle: 'bold' } },
            didParseCell: (data) => {
                if (data.column.index === 0 && data.row.index % 3 !== 0) data.cell.text = '';
            }
        });
        doc.save(`EDT_GLOBAL_${mode.toUpperCase()}_${weekData.semaine}.pdf`);
    } catch (error) {
        console.error('Erreur PDF Global:', error);
        alert('Erreur lors de la génération du PDF Global: ' + error.message);
    } finally {
        loadingOverlay.style.display = 'none';
    }
}

function getDatesForISOWeek(weekString) {
    if (!weekString) return { dateDebut: '', dateFin: ''};
    const [year, week] = weekString.split('-W').map(Number);
    const simple = new Date(year, 0, 1 + (week - 1) * 7);
    const dow = simple.getDay();
    const isoWeekStart = new Date(simple);
    isoWeekStart.setDate(simple.getDate() - (dow === 0 ? 6 : dow - 1) + 1);
    const isoWeekEnd = new Date(isoWeekStart);
    isoWeekEnd.setDate(isoWeekStart.getDate() + 5);
    return { dateDebut: isoWeekStart.toISOString().split('T')[0], dateFin: isoWeekEnd.toISOString().split('T')[0] };
}
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date)) return '';
    const day = String(date.getUTCDate()).padStart(2, '0');
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const year = date.getUTCFullYear();
    return `${day}/${month}/${year}`;
}
async function downloadPDF(type) {
            const loadingOverlay = document.getElementById('pdf-loading-overlay');
            const loadingMessage = document.getElementById('pdf-loading-message');
            
            if ((type === 'teacher' && !selectedTeacher) || (type === 'group' && !selectedGroup)) {
                alert(`Veuillez sélectionner un ${type === 'teacher' ? 'formateur' : 'groupe'}`);
                return;
            }
            
            loadingMessage.textContent = `Génération du PDF pour le ${type}...`;
            loadingOverlay.style.display = 'flex';

            try {
                const logoBase64 = await loadImageAsBase64('assets/images/logo_ofppt.png');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                doc.addImage(logoBase64, 'png', 13, 8, 22, 22);

                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text("Direction : DRCS", 14, 38);
                doc.text("Complexe/EFP : CFP-BEN M'SIK/ ISTA IBM", 14, 44);
                
                if (type === 'group') {
                    const AF = selectedGroup.slice(-3) < 200 ? "1A" : "2A";
                    doc.text(`Année de formation : ${AF}`, 14, 50);
                }

                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`EMPLOI DU TEMPS ${type.toUpperCase()}`, 160, 24, { align: 'center' });
                doc.text("Au Titre de l'année 2024-2025", 160, 31, { align: 'center' });
                
                let masseHoraire = 0;
                const dureeCreneaux = { 'S1': 2.5, 'S2': 2.5, 'S3': 2.5, 'S4': 2.5 };
                const emploi = historique[selectedWeekIndex].emploiDuTemps;
                
                if (type === 'teacher') {
                    const teacherEmploi = emploi[selectedTeacher];
                    for (const day in teacherEmploi) {
                        for (const creneauId in teacherEmploi[day]) {
                            if (teacherEmploi[day][creneauId]?.groupe) masseHoraire += dureeCreneaux[creneauId] || 0;
                        }
                    }
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Formateur : ${selectedTeacher}`, 250, 55, { align: 'center' });
                } else {
                    for (const formateur in emploi) {
                        for (const jour in emploi[formateur]) {
                            for (const creneauId in emploi[formateur][jour]) {
                                const cours = emploi[formateur][jour][creneauId];
                                if (cours.groupe && cours.groupe.split(' ').includes(selectedGroup)) {
                                    masseHoraire += dureeCreneaux[creneauId] || 0;
                                }
                            }
                        }
                    }
                    doc.text(`Groupe : ${selectedGroup}`, 250, 55, { align: 'center' });
                }
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Masse Horaire : ${Math.round(masseHoraire * 100) / 100} H`, 14, 56);
                const week = historique[selectedWeekIndex];
                const weeklabel1 = week.semaine.replace('2025-', '').replace('W', 'S');
                const { dateDebut, dateFin } = getDatesForISOWeek(week.semaine);
                doc.text(`Période d'application: ${weeklabel1} (${formatDate(dateDebut)} - ${formatDate(dateFin)})`, 112, 56);
                
                const timeSlots = [
                    { id: 'S1', label: '8H30-11H' }, { id: 'S2', label: '11H-13H30' },
                    { id: 'S3', label: '13H30-16H' }, { id: 'S4', label: '16H-18H30' }
                ];

                const initialTableData = [];
                days.forEach(day => {
                    const info1Row = [day, type === 'teacher' ? 'Groupe' : 'Formateur'];
                    const info2Row = ['', 'Module'];
                    const info3Row = ['', 'Espace'];

                    timeSlots.forEach(slot => {
                        let content1 = '', content2 = '', content3 = '';
                        if (type === 'teacher') {
                            const cours = emploi[selectedTeacher]?.[day]?.[slot.id];
                            content1 = cours?.groupe || ''; content2 = cours?.module || ''; content3 = cours?.salle || '';
                        } else {
                            for (const teacher in emploi) {
                                const cours = emploi[teacher]?.[day]?.[slot.id];
                                if (cours?.groupe && cours.groupe.split(' ').includes(selectedGroup)) {
                                    content1 = teacher; content2 = cours.module; content3 = cours.salle;
                                    break;
                                }
                            }
                        }
                        info1Row.push(content1); info2Row.push(content2); info3Row.push(content3);
                    });
                    initialTableData.push(info1Row, info2Row, info3Row);
                });

                for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
                    const startRow = dayIndex * 3;
                    for (let timeIndex = 0; timeIndex < timeSlots.length; timeIndex++) {
                        const colIndex = 2 + timeIndex;
                        const isEmpty = !initialTableData[startRow][colIndex] && !initialTableData[startRow + 1][colIndex] && !initialTableData[startRow + 2][colIndex];
                        if (isEmpty) {
                            initialTableData[startRow][colIndex] = { content: '', rowSpan: 3 };
                            initialTableData[startRow + 1][colIndex] = null;
                            initialTableData[startRow + 2][colIndex] = null;
                        }
                    }
                }
                // (Le reste de la logique de fusion et de génération PDF reste identique)

                doc.autoTable({
                    startY: 65,
                    head: [['', '', '8H30-11H', '11H-13H30', '13H30-16H', '16H-18H30']],
                    body: initialTableData, // Utilisation des données préparées
                    theme: 'grid',
                    // ... (styles et hooks didDrawCell/didParseCell comme avant)
                });
                
                doc.save(`EDT_${type.toUpperCase()}_${type === 'teacher' ? selectedTeacher : selectedGroup}_${week.semaine}.pdf`);

            } catch (error) {
                console.error('Erreur PDF:', error);
                alert('Erreur lors de la génération du PDF: ' + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }


        function displayDefaultSpecificView() {
            updateDataForWeek();
            updateAutocompleteLists();
            const sortedGroups = Array.from(groups).sort();

            if (currentMode === 'formateur') {
                document.getElementById('group-schedule-table').innerHTML = '';
                selectedGroup = '';
                document.getElementById('group-search').value = '';
                if (teachers.length > 0) {
                    selectedTeacher = teachers[0];
                    document.getElementById('teacher-search').value = teachers[0];
                    displayTeacherSchedule(teachers[0]);
                } else {
                    selectedTeacher = ''; document.getElementById('teacher-search').value = '';
                    document.getElementById('teacher-schedule-table').innerHTML = '<tbody><tr><td colspan="6">Aucun formateur disponible.</td></tr></tbody>';
                }
            } else {
                document.getElementById('teacher-schedule-table').innerHTML = '';
                selectedTeacher = '';
                document.getElementById('teacher-search').value = '';
                if (sortedGroups.length > 0) {
                    selectedGroup = sortedGroups[0];
                    document.getElementById('group-search').value = sortedGroups[0];
                    displayGroupSchedule(sortedGroups[0]);
                } else {
                    selectedGroup = ''; document.getElementById('group-search').value = '';
                    document.getElementById('group-schedule-table').innerHTML = '<tbody><tr><td colspan="6">Aucun groupe disponible.</td></tr></tbody>';
                }
            }
        }
    
    // --- ASSISTANT VOCAL ---
    const voiceAssistantBtn = document.getElementById('voiceAssistantBtn');
    const assistantStatus = document.getElementById('assistantStatus');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'fr-FR';
        recognition.interimResults = false;
        setupVoiceAssistant();
    } else {
        voiceAssistantBtn.style.display = 'none';
    }

    function setupVoiceAssistant() {
        voiceAssistantBtn.addEventListener('click', toggleListening);
        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            updateStatus(`J'ai entendu : "${transcript}"`);
            processCommand(transcript);
        };
        recognition.onerror = () => {
            updateStatus("Désolé, je n'ai pas compris.", 3000, true);
            stopListening();
        };
        recognition.onend = () => stopListening();
    }
    
    function toggleListening() {
        if (voiceAssistantBtn.classList.contains('listening')) recognition.stop();
        else startListening();
    }

    function startListening() {
        voiceAssistantBtn.classList.add('listening');
        voiceAssistantBtn.querySelector('span i').className = 'fas fa-wave-square';
        updateStatus("Je vous écoute...", 0);
        recognition.start();
    }

    function stopListening() {
        voiceAssistantBtn.classList.remove('listening');
        voiceAssistantBtn.querySelector('span i').className = 'fas fa-microphone';
        setTimeout(() => assistantStatus.classList.remove('visible'), 500);
    }

    function updateStatus(message, duration = 2000, isError = false) {
        assistantStatus.textContent = message;
        assistantStatus.style.backgroundColor = isError ? '#e74c3c' : 'rgba(0, 0, 0, 0.75)';
        assistantStatus.classList.add('visible');
        if (duration > 0) setTimeout(() => assistantStatus.classList.remove('visible'), duration);
    }
    
    function speak(text) {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'fr-FR';
        utterance.rate = 1.1;
        speechSynthesis.speak(utterance);
    }

    async function processCommand(command) {
        const GEMINI_API_KEY = 'AIzaSyCtvJkZ0xp7eSEIVVThjiYQ9HsK84ca_bU'; 
        if(GEMINI_API_KEY.includes('VOTRE_CLE')) {
            const errorMsg = "Erreur : Clé API Gemini non configurée.";
            speak(errorMsg); updateStatus(errorMsg, 4000, true); return;
        }
        updateStatus('Analyse en cours...', 0);
        const system_prompt = `
            Tu es un assistant pour une page d'édition d'emplois du temps. Convertis la requête en JSON.
            Contexte: Formateurs valides: ${teachers.map(t=>t.toUpperCase()).join(', ')}. Groupes valides: ${Array.from(groups).map(g=>g.toUpperCase()).join(', ')}.
            Intents: 'telecharger_pdf', 'changer_vue', 'changer_mode', 'selectionner_semaine', 'naviguer_page', 'inconnue'.
            Format de réponse JSON OBLIGATOIRE: {"intent": "...", "parameters": {"cible": "...", "nom": "...", "vue": "...", "mode": "...", "semaine": ..., "page": "..."}, "response": "..."}
            Exemples:
            - "Télécharge le PDF pour Dupont" -> {"intent": "telecharger_pdf", "parameters": {"cible": "formateur", "nom": "DUPONT"}, "response": "Je prépare le PDF pour Dupont."}
            - "Exporte le global des groupes" -> {"intent": "telecharger_pdf", "parameters": {"cible": "global", "mode": "groupe"}, "response": "PDF global pour les groupes en cours."}
            Analyse: "${command}"
        `;
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: system_prompt }] }] }),
            });
            if (!response.ok) throw new Error('API Google non valide.');
            const data = await response.json();
            const rawText = data.candidates[0].content.parts[0].text;
            const result = JSON.parse(rawText.replace(/```json|```/g, '').trim());
            speak(result.response);
            switch (result.intent) {
                case 'telecharger_pdf': handleDownloadCommand(result.parameters); break;
                case 'changer_vue': if ((result.parameters.vue === 'detaillee' && currentView === 'global') || (result.parameters.vue === 'globale' && currentView === 'specific')) toggleView(); break;
                case 'changer_mode': if (result.parameters.mode === 'formateur') document.getElementById('tab1').click(); else if (result.parameters.mode === 'groupe') document.getElementById('tab2').click(); break;
                case 'selectionner_semaine': if (result.parameters.semaine) { const schoolYear = getSchoolYear(new Date()); let firstMonday = getWeekInfo(new Date(schoolYear, 8, 1)).startOfWeek; let targetDate = new Date(firstMonday); targetDate.setDate(firstMonday.getDate() + (result.parameters.semaine - 1) * 7); updateWeekSelection(targetDate); } break;
                case 'naviguer_page': const pageMap = {'accueil': 'admin.html', 'edition': 'edition.html', 'avancement': 'avancement.html', 'espaces': 'espaces.html'}; if (result.parameters.page && pageMap[result.parameters.page]) window.location.href = pageMap[result.parameters.page]; break;
            }
        } catch (error) {
            console.error("Erreur Gemini:", error);
            speak("Désolé, une erreur est survenue.");
            updateStatus("Erreur de communication", 4000, true);
        }
    }
    
    function handleDownloadCommand(params) {
        const { cible, nom, mode } = params;
        if (cible === 'global') {
            if (mode && mode !== currentMode) switchMode(mode);
            if (currentView !== 'global') toggleView();
            setTimeout(() => document.getElementById('download-global-pdf-btn').click(), 300);
        } else if (cible === 'formateur' || cible === 'groupe') {
            if (!nom) { speak("Veuillez spécifier un nom."); return; }
            if (currentView !== 'specific') toggleView();
            switchMode(cible);
            setTimeout(() => {
                const searchInput = document.getElementById(`${cible}-search`);
                const list = document.getElementById(`${cible}-autocomplete-list`);
                searchInput.value = nom;
                const item = Array.from(list.children).find(c => c.textContent.toUpperCase() === nom.toUpperCase());
                if (item) {
                    item.click();
                    setTimeout(() => document.getElementById(`download-${cible}-pdf`).click(), 500);
                } else {
                    speak(`Désolé, je ne trouve pas le ${cible} nommé ${nom}.`);
                }
            }, 500);
        }
    }

    function getInitials(name) {
        if (!name) return '--';
        const words = name.trim().split(' ');
        if (words.length === 1) return words[0].substring(0, 2).toUpperCase();
        return (words[0][0] + words[words.length - 1][0]).toUpperCase();
    }

    function populateUserInfo(userData) {
    if (!userData) return;
    document.getElementById('profile-initials').textContent = getInitials(userData.nom);
    document.getElementById('dropdown-user-name').textContent = userData.nom;
    document.getElementById('dropdown-user-email').textContent = userData.email;
}

function setupProfileMenu() {
    const profileButton = document.getElementById('profile-button');
    const profileDropdown = document.getElementById('profile-dropdown');

    if (profileButton && profileDropdown) {
        profileButton.addEventListener('click', (event) => {
            event.stopPropagation(); 
            profileDropdown.classList.toggle('show');
        });
        window.addEventListener('click', (event) => {
            if (profileDropdown.classList.contains('show') && !profileDropdown.contains(event.target)) {
                profileDropdown.classList.remove('show');
            }
        });
    }
}

async function checkSessionAndLoad() {
    try {
        const response = await fetch('../api/auth/verify_session.php');
        const result = await response.json();
        if (!result.success) {
            window.location.href = 'login.html';
            return;
        }
        populateUserInfo(result.userData);
        setupProfileMenu();
        loadData();
    } catch (error) {
        console.error('Session check failed:', error);
        window.location.href = 'login.html';
    }
}
document.addEventListener('DOMContentLoaded', checkSessionAndLoad);
    </script>
</body>
</html>