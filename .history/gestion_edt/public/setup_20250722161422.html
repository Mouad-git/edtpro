<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Configuration Initiale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <!-- On charge la bibliothèque de calendrier Flatpickr et son thème -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- On charge la traduction française pour Flatpickr -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
    <style>
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Style pour les tags (jours fériés, vacances) */
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            margin: 4px;
        }
        .tag button {
            margin-left: 8px; background: none; border: none; cursor: pointer;
            color: #6366f1; font-size: 1rem; line-height: 1;
        }
        .tag button:hover { color: #4338ca; }

        /* --- NOUVEAU STYLE POUR LA BARRE DE PROGRESSION --- */
        .stepper-item {
            @apply relative flex flex-col justify-center items-center w-24;
        }
        /* La ligne de connexion entre les points */
        .stepper-item:not(:last-child)::after {
            content: '';
            @apply absolute w-full h-0.5 bg-gray-300;
            top: 20px; /* Aligné verticalement avec le centre du cercle */
            left: 50%;
            transform: translateY(-50%);
            z-index: -1;
        }
        /* Style pour la ligne quand l'étape est terminée */
        .stepper-item.completed:not(:last-child)::after {
            @apply bg-blue-600;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-4xl bg-white p-6 md:p-8 rounded-xl shadow-lg">
        
        <!-- === NOUVELLE BARRE DE PROGRESSION === -->
        <div class="w-full px-4 sm:px-12 mb-12">
            <div class="flex items-start justify-between">
                <!-- Étape 1 -->
                <div id="progress-step-1" class="stepper-item completed">
                    <div id="progress-circle-1" class="z-10 flex items-center justify-center w-10 h-10 bg-blue-600 text-white rounded-full font-bold transition-colors duration-300">
                        <span>1</span>
                    </div>
                    <div id="progress-label-1" class="mt-2 text-center text-sm font-bold text-blue-600 transition-colors duration-300">Fichier</div>
                </div>
                <!-- Étape 2 -->
                <div id="progress-step-2" class="stepper-item">
                     <div id="progress-circle-2" class="z-10 flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-600 rounded-full font-bold transition-colors duration-300">
                        <span>2</span>
                    </div>
                    <div id="progress-label-2" class="mt-2 text-center text-sm font-semibold text-gray-500 transition-colors duration-300">Formateurs</div>
                </div>
                <!-- Étape 3 -->
                <div id="progress-step-3" class="stepper-item">
                     <div id="progress-circle-3" class="z-10 flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-600 rounded-full font-bold transition-colors duration-300">
                        <span>3</span>
                    </div>
                    <div id="progress-label-3" class="mt-2 text-center text-sm font-semibold text-gray-500 transition-colors duration-300">Calendrier</div>
                </div>
                <!-- Étape 4 -->
                <div id="progress-step-4" class="stepper-item">
                     <div id="progress-circle-4" class="z-10 flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-600 rounded-full font-bold transition-colors duration-300">
                        <span>4</span>
                    </div>
                    <div id="progress-label-4" class="mt-2 text-center text-sm font-semibold text-gray-500 transition-colors duration-300">Espaces</div>
                </div>
            </div>
        </div>
        
        <!-- === ÉTAPE 1 : UPLOAD DU FICHIER === -->
        <div id="step1" class="step active">
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Étape 1 : Importez votre fichier de base</h2>
            <p class="mb-6 text-gray-600 text-center">Veuillez sélectionner le fichier Excel "AvancementProgramme" fourni. Le système extraira automatiquement la liste de vos formateurs.</p>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 hover:bg-gray-100 hover:border-blue-500 transition-all duration-300">
                <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
                <label for="excelFile" class="cursor-pointer">
                    <i class="fas fa-cloud-upload-alt text-5xl text-blue-500 mb-4 inline-block"></i>
                    <p class="text-lg font-semibold text-gray-700">Cliquez pour choisir un fichier</p>
                    <p id="fileName" class="text-sm text-gray-500 mt-2 font-medium"></p>
                </label>
            </div>
            <div id="step1-feedback" class="text-red-500 mt-4 text-center font-semibold"></div>
            <button id="step1NextBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg mt-6 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-bold transition-all duration-300" disabled>
                Suivant <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <!-- === ÉTAPE 2 : VÉRIFICATION DES FORMATEURS === -->
        <div id="step2" class="step">
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Étape 2 : Vérifiez les informations des formateurs</h2>
            <p class="mb-6 text-gray-600 text-center">Les e-mails et matricules ont été générés automatiquement. Veuillez les vérifier et les corriger si nécessaire.</p>
            <div class="overflow-y-auto max-h-[50vh] border rounded-lg shadow-inner">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-3 font-semibold">Nom du Formateur</th>
                            <th class="p-3 font-semibold w-48">Masse Horaire Stat.</th>
                            <th class="p-3 font-semibold w-48">Matricule</th>
                            <th class="p-3 font-semibold">E-mail</th>
                        </tr>
                    </thead>
                    <tbody id="formateurs-table-body" class="divide-y divide-gray-200">
                        <!-- Le contenu sera généré par JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex gap-4 mt-6">
                <button id="step2PrevBtn" class="w-1/3 bg-gray-200 text-gray-800 p-3 rounded-lg hover:bg-gray-300 font-bold transition-all duration-300">Précédent</button>
                <button id="step2NextBtn" class="w-2/3 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-bold flex items-center justify-center gap-2 transition-all duration-300">Suivant <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- === ÉTAPE 3 : JOURS FÉRIÉS ET VACANCES === -->
        <div id="step3" class="step">
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Étape 3 : Configurez le calendrier de l'année</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                <div>
                    <label for="holidays" class="block font-medium text-gray-700 mb-2">Jours fériés</label>
                    <input type="text" id="holidays" class="w-full p-2 border rounded-md" placeholder="Sélectionnez les jours fériés...">
                    <div id="holidays-tags" class="mt-4 flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <label for="vacations" class="block font-medium text-gray-700 mb-2">Périodes de vacances</label>
                    <input type="text" id="vacations" class="w-full p-2 border rounded-md" placeholder="Sélectionnez les périodes de vacances...">
                    <div id="vacations-tags" class="mt-4 flex flex-wrap gap-2"></div>
                </div>
            </div>
             <div class="flex gap-4 mt-8">
                <button id="step3PrevBtn" class="w-1/3 bg-gray-200 text-gray-800 p-3 rounded-lg hover:bg-gray-300 font-bold transition-all duration-300">Précédent</button>
                <button id="step3NextBtn" class="w-2/3 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-bold flex items-center justify-center gap-2 transition-all duration-300">Suivant <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- === ÉTAPE 4 : ESPACES === -->
        <div id="step4" class="step">
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Étape 4 : Listez vos espaces de travail</h2>
            <p class="mb-6 text-gray-600 text-center">Entrez la liste de toutes vos salles, amphis, laboratoires, etc. (un par ligne). N'oubliez pas d'inclure "TEAMS" pour les cours à distance.</p>
            <textarea id="espaces" class="w-full p-3 border rounded-md h-48 shadow-inner" placeholder="Salle A101
Amphi B
Labo Info
TEAMS"></textarea>
            <div id="step4-feedback" class="text-red-500 mt-4 text-center font-semibold"></div>
            <div class="flex gap-4 mt-6">
                <button id="step4PrevBtn" class="w-1/3 bg-gray-200 text-gray-800 p-3 rounded-lg hover:bg-gray-300 font-bold transition-all duration-300">Précédent</button>
                <button id="finishSetupBtn" class="w-2/3 bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 font-bold flex items-center justify-center gap-2 transition-all duration-300">
                    Terminer et Sauvegarder <i class="fas fa-check"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- SCRIPT D'INITIALISATION ---
        async function checkSessionAndLoad() {
            try {
                const response = await fetch('../api/auth/verify_session.php');
                const result = await response.json();
                if (!result.success) {
                    window.location.href = 'login.html';
                } else {
                    initializeSetupPage();
                }
            } catch (error) {
                window.location.href = 'login.html';
            }
        }
        
        document.addEventListener('DOMContentLoaded', checkSessionAndLoad);

        // --- LOGIQUE DE LA PAGE ---
        function initializeSetupPage() {
            // Références aux éléments du DOM
            const steps = [
                document.getElementById('step1'), document.getElementById('step2'),
                document.getElementById('step3'), document.getElementById('step4')
            ];
            const fileInput = document.getElementById('excelFile');
            const fileNameLabel = document.getElementById('fileName');
            const formateursTableBody = document.getElementById('formateurs-table-body');
            const feedbacks = {
                step1: document.getElementById('step1-feedback'),
                step4: document.getElementById('step4-feedback')
            };

            let rawExcelData = null;

            // --- NAVIGATION ENTRE LES ÉTAPES ---
            const nextButtons = {
                1: document.getElementById('step1NextBtn'),
                2: document.getElementById('step2NextBtn'),
                3: document.getElementById('step3NextBtn'),
            };
            const prevButtons = {
                2: document.getElementById('step2PrevBtn'),
                3: document.getElementById('step3PrevBtn'),
                4: document.getElementById('step4PrevBtn'),
            };

            function goToStep(stepNumber) {
                steps.forEach((step, index) => {
                    step.classList.toggle('active', (index + 1) === stepNumber);
                });
                updateProgress(stepNumber);
            }

            // *** FONCTION DE MISE À JOUR DE LA BARRE DE PROGRESSION MODIFIÉE ***
            function updateProgress(currentStep) {
                for (let i = 1; i <= 4; i++) {
                    const stepEl = document.getElementById(`progress-step-${i}`);
                    const circleEl = document.getElementById(`progress-circle-${i}`);
                    const labelEl = document.getElementById(`progress-label-${i}`);

                    // Reset classes
                    stepEl.classList.remove('completed');
                    circleEl.classList.remove('bg-blue-600', 'bg-green-600', 'text-white');
                    labelEl.classList.remove('font-bold', 'text-blue-600', 'text-gray-500');

                    if (i < currentStep) { // Étapes complétées
                        stepEl.classList.add('completed');
                        circleEl.classList.add('bg-blue-600', 'text-white');
                        labelEl.classList.add('font-semibold', 'text-gray-700');
                    } else if (i === currentStep) { // Étape active
                        stepEl.classList.add('completed'); // Pour colorer la ligne precedente
                        circleEl.classList.add('bg-blue-600', 'text-white');
                        labelEl.classList.add('font-bold', 'text-blue-600');
                    } else { // Étapes restantes
                        circleEl.classList.add('bg-gray-300', 'text-gray-600');
                        labelEl.classList.add('font-semibold', 'text-gray-500');
                    }
                }
            }
            
            // --- GESTION DES BOUTONS SUIVANT / PRÉCÉDENT ---
            nextButtons[1].addEventListener('click', () => handleStep1Next());
            nextButtons[2].addEventListener('click', () => goToStep(3));
            nextButtons[3].addEventListener('click', () => goToStep(4));

            prevButtons[2].addEventListener('click', () => goToStep(1));
            prevButtons[3].addEventListener('click', () => goToStep(2));
            prevButtons[4].addEventListener('click', () => goToStep(3));

            // --- LOGIQUE DE L'ÉTAPE 1 ---
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileNameLabel.textContent = this.files[0].name;
                    nextButtons[1].disabled = false;
                }
            });

            function handleStep1Next() {
                const formData = new FormData();
                formData.append('excelFile', fileInput.files[0]);
                
                nextButtons[1].innerHTML = 'Analyse... <i class="fas fa-spinner fa-spin"></i>';
                nextButtons[1].disabled = true;

                fetch('../api/setup/parse_formateurs.php', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            rawExcelData = result.rawExcelData;
                            populateFormateursTable(result.formateurs);
                            goToStep(2);
                        } else {
                            feedbacks.step1.textContent = result.message || "Erreur d'analyse.";
                        }
                    }).finally(() => {
                        nextButtons[1].innerHTML = 'Suivant <i class="fas fa-arrow-right"></i>';
                        // Keep it disabled, file must be reselected if there's an error
                        // nextButtons[1].disabled = false;
                    });
            }

            // --- LOGIQUE DE L'ÉTAPE 2 ---
            function populateFormateursTable(formateurs) {
                formateursTableBody.innerHTML = '';
                formateurs.forEach(f => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50 transition-colors duration-200";
                    row.innerHTML = `
                        <td class="p-3 font-semibold text-gray-800 nom">${f.nom}</td>
                        <td class="p-3"><input type="number" class="w-full p-2 border rounded masse_horaire" value="${f.masse_horaire}"></td>
                        <td class="p-3"><input type="text" class="w-full p-2 border rounded bg-gray-100 matricule" value="${f.matricule}" readonly></td>
                        <td class="p-3"><input type="email" class="w-full p-2 border rounded email" value="${f.email}" placeholder="E-mail personnel si vacataire"></td>
                    `;
                    formateursTableBody.appendChild(row);
                });
            }

            // --- LOGIQUE DE L'ÉTAPE 3 ---
            const holidaysPicker = flatpickr("#holidays", {
                mode: "multiple", dateFormat: "d/m/Y", locale: "fr",
                onChange: (selectedDates) => updateTags('holidays', selectedDates.map(d => holidaysPicker.formatDate(d, "d/m/Y")))
            });
            const vacationsPicker = flatpickr("#vacations", {
                mode: "range", dateFormat: "d/m/Y", locale: "fr",
                onClose: (selectedDates) => {
                    if (selectedDates.length === 2) {
                        const rangeStr = `${vacationsPicker.formatDate(selectedDates[0], "d/m/Y")} - ${vacationsPicker.formatDate(selectedDates[1], "d/m/Y")}`;
                        addTag('vacations', rangeStr);
                    }
                }
            });

            function updateTags(type, values) {
                document.getElementById(`${type}-tags`).innerHTML = '';
                values.forEach(value => addTag(type, value));
            }

            function addTag(type, value) {
                const container = document.getElementById(`${type}-tags`);
                if (Array.from(container.querySelectorAll('.tag')).find(t => t.dataset.value === value)) return;

                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.dataset.value = value;
                tag.innerHTML = `${value} <button type="button">×</button>`;
                tag.querySelector('button').onclick = () => {
                    tag.remove();
                    if (type === 'holidays') {
                        holidaysPicker.setDate(getTagsValues('holidays'));
                    }
                };
                container.appendChild(tag);
            }
            
            function getTagsValues(type) {
                return Array.from(document.getElementById(`${type}-tags`).querySelectorAll('.tag')).map(t => t.dataset.value);
            }
            
            // --- LOGIQUE DE L'ÉTAPE 4 ---
            const finishSetupBtn = document.getElementById('finishSetupBtn');
            finishSetupBtn.addEventListener('click', function() {
                const formateursData = Array.from(formateursTableBody.querySelectorAll('tr')).map(row => ({
                    nom: row.querySelector('.nom').textContent,
                    masse_horaire: row.querySelector('.masse_horaire').value,
                    matricule: row.querySelector('.matricule').value,
                    email: row.querySelector('.email').value
                }));

                const finalData = {
                    excelData: rawExcelData,
                    formateursData: formateursData,
                    holidays: getTagsValues('holidays'),
                    vacations: getTagsValues('vacations'),
                    espaces: document.getElementById('espaces').value.trim().split('\n').filter(Boolean)
                };

                this.innerHTML = 'Sauvegarde... <i class="fas fa-spinner fa-spin"></i>';
                this.disabled = true;

                fetch('../api/setup/complete_setup.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalData)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Optionnel : Afficher un état de succès final
                        circleEl = document.getElementById(`progress-circle-4`);
                        circleEl.classList.remove('bg-blue-600');
                        circleEl.classList.add('bg-green-600');
                        document.getElementById('progress-step-4').classList.add('completed');
                        setTimeout(() => { window.location.href = 'admin.html'; }, 1000);
                    } else {
                        feedbacks.step4.textContent = result.message || "Erreur lors de la sauvegarde.";
                        this.innerHTML = 'Terminer et Sauvegarder <i class="fas fa-check"></i>';
                        this.disabled = false;
                    }
                });
            });

            // Initialiser l'état au chargement de la page
            goToStep(1);
        }
    </script>
</body>
</html>