async function checkSessionAndLoad(){try{let e=await fetch("../api/auth/verify_session.php"),t=await e.json();if(!t.success){window.location.href="login.html";return}populateUserInfo(t.userData),setupProfileMenu(),loadPageData(),setupTabNavigation(),setupFormSubmissions()}catch(n){console.error("Erreur:",n),window.location.href="login.html"}}function getInitials(e){if(!e||"string"!=typeof e)return"--";let t=e.trim().split(" ");return 1===t.length?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function populateUserInfo(e){if(!e)return;let t=document.getElementById("profile-initials");t&&(t.textContent=getInitials(e.nom));let n=document.getElementById("dropdown-user-name"),a=document.getElementById("dropdown-user-email");n&&(n.textContent=e.nom),a&&(a.textContent=e.email);let s=document.getElementById("profile-page-initials"),o=document.getElementById("profile-page-name"),l=document.getElementById("profile-page-etablissement"),r=e.nom_complet||e.nom;s&&(s.textContent=getInitials(r)),o&&(o.textContent=r),l&&(l.textContent=e.nom_etablissement)}function setupProfileMenu(){let e=document.getElementById("profile-button"),t=document.getElementById("profile-dropdown");e&&t&&e.addEventListener("click",e=>{e.stopPropagation(),t.classList.toggle("show")}),window.addEventListener("click",()=>{t&&t.classList.contains("show")&&t.classList.remove("show")})}function loadPageData(){fetch("../api/profile/get_profile_data.php").then(e=>e.json()).then(e=>{if(e.success){let t=e.data;document.getElementById("nom_complet").value=t.user.nom_complet||"",document.getElementById("email").value=t.user.email||"",document.getElementById("etablissement_name").textContent=t.user.nom_etablissement||"",document.getElementById("complexe_name").textContent=t.user.complexe||"",document.getElementById("espaces").value=(t.espaces||[]).join("\n")||"";let n=document.getElementById("espaces-tag-container");n.querySelectorAll(".tag").forEach(e=>e.remove());let a=t.espaces||[];a.forEach(e=>{createEspaceTag(e)}),updateHiddenEspacesTextarea(),document.getElementById("holidays").value=t.calendar.holidays||"",document.getElementById("vacations").value=t.calendar.vacations||"";let s=document.getElementById("formateurs-table-body");s.innerHTML="",(t.formateurs||[]).forEach(e=>{let t=`
                                <tr>
                                    <td>${e.nom||""}</td><td>${e.matricule||""}</td>
                                    <td><input name="formateurs[${e.matricule}][masse_horaire]" type="number" class="form-control" value="${e.masse_horaire||""}"></td>
                                    <td><input name="formateurs[${e.matricule}][email]" type="email" class="form-control" value="${e.email||""}"></td>
                                    <input type="hidden" name="formateurs[${e.matricule}][nom]" value="${e.nom||""}"><input type="hidden" name="formateurs[${e.matricule}][matricule]" value="${e.matricule||""}">
                                </tr>`;s.innerHTML+=t})}else alert("Erreur: Impossible de charger les donn\xe9es du profil.")}).catch(e=>{console.error("Erreur lors du chargement des donn\xe9es:",e),alert("Une erreur s'est produite lors du chargement des donn\xe9es du profil.")})}function setupEspacesTagInput(){let e=document.getElementById("espaces-tag-container"),t=document.getElementById("espaces-input");e.addEventListener("click",()=>{t.focus()}),t.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();let n=t.value.trim();n&&(createEspaceTag(n),t.value="",updateHiddenEspacesTextarea())}})}function createEspaceTag(e){let t=document.getElementById("espaces-tag-container"),n=document.getElementById("espaces-input"),a=document.createElement("div");a.className="tag";let s=document.createElement("span");s.textContent=e;let o=document.createElement("span");o.className="tag-remove",o.innerHTML="\xd7",o.addEventListener("click",()=>{a.remove(),updateHiddenEspacesTextarea()}),a.appendChild(s),a.appendChild(o),t.insertBefore(a,n)}function updateHiddenEspacesTextarea(){let e=document.getElementById("espaces-tag-container"),t=e.querySelectorAll(".tag"),n=document.getElementById("espaces"),a=Array.from(t).map(e=>e.querySelector("span").textContent);n.value=a.join("\n")}function setupTabNavigation(){let e=document.querySelectorAll(".sidebar-link"),t=document.querySelectorAll(".panel");e.forEach(n=>{n.addEventListener("click",a=>{a.preventDefault(),e.forEach(e=>e.classList.remove("active")),n.classList.add("active");let s=n.dataset.target;t.forEach(e=>e.classList.remove("active"));let o=document.getElementById(s);o&&o.classList.add("active")})})}function showFeedback(e,t,n){let a=document.getElementById(e);a&&(a.textContent=t,a.className=n?"feedback-message feedback-success":"feedback-message feedback-error",setTimeout(()=>{a.textContent=""},4e3))}function setupFormSubmissions(){document.getElementById("userInfoForm").addEventListener("submit",function(e){e.preventDefault();let t={nom_complet:document.getElementById("nom_complet").value,email:document.getElementById("email").value};fetch("../api/profile/update_user_info.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{showFeedback("userInfoFeedback",e.message,e.success),e.success&&populateUserInfo({nom:t.nom_complet,email:t.email,nom_complet:t.nom_complet,nom_etablissement:document.getElementById("profile-page-etablissement").textContent})})}),document.getElementById("passwordForm").addEventListener("submit",function(e){e.preventDefault();let t=document.getElementById("new_password").value,n=document.getElementById("confirm_new_password").value;if(t!==n){showFeedback("passwordFeedback","Les mots de passe ne correspondent pas.",!1);return}fetch("../api/profile/update_password.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({new_password:t,confirm_new_password:n})}).then(e=>e.json()).then(e=>{showFeedback("passwordFeedback",e.message,e.success),e.success&&this.reset()})}),document.getElementById("espacesForm").addEventListener("submit",function(e){e.preventDefault();let t={espaces:document.getElementById("espaces").value.split("\n").map(e=>e.trim()).filter(e=>e.length>0)};fetch("../api/profile/update_establishment_info.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>showFeedback("espacesFeedback",e.message,e.success))}),document.getElementById("calendarForm").addEventListener("submit",function(e){e.preventDefault();let t={holidays:document.getElementById("holidays").value,vacations:document.getElementById("vacations").value};fetch("../api/profile/update_establishment_info.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>showFeedback("calendarFeedback",e.message,e.success))}),document.getElementById("formateursForm").addEventListener("submit",function(e){e.preventDefault();let t=new FormData(this),n={};for(let[a,s]of t.entries()){let o=a.match(/formateurs\[(.+?)]\[(.+?)]/);if(o){let l=o[1],r=o[2];n[l]||(n[l]={}),n[l][r]=s}}let i={formateurs:Object.values(n)};fetch("../api/profile/update_formateurs.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(e=>e.json()).then(e=>showFeedback("formateursFeedback",e.message,e.success))})}document.addEventListener("DOMContentLoaded",()=>{checkSessionAndLoad(),setupEspacesTagInput()});