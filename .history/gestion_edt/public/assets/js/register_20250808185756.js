document.addEventListener("DOMContentLoaded",async function(){let e=document.getElementById("complexeSelect"),t=document.getElementById("etablissementSelect"),n=document.getElementById("nom_etablissement");try{let s=await fetch("data/etablissements.json");if(!s.ok)throw Error("Le fichier etablissements.json n'a pas pu \xeatre charg\xe9.");let a=await s.json(),i=Object.keys(a).sort();i.forEach(t=>{let n=new Option(t,t);e.appendChild(n)}),e.addEventListener("change",function(){let e=this.value;t.innerHTML='<option value="">-- S\xe9lectionnez un \xe9tablissement --</option>',n.value="",document.getElementById("complexe").value=e,e?(t.disabled=!1,a[e].sort().forEach(e=>{t.appendChild(new Option(e,e))})):t.disabled=!0}),t.addEventListener("change",function(){n.value=this.value})}catch(r){console.error("Erreur critique lors du chargement des \xe9tablissements:",r),e.innerHTML='<option value="">Erreur de chargement</option>',e.disabled=!0,t.disabled=!0}let l=document.getElementById("email_username"),o=document.getElementById("email");l&&o&&l.addEventListener("input",function(){o.value=`${this.value}@gmail.com`});let m=document.getElementById("mot_de_passe"),d=document.getElementById("togglePasswordIcon");d.addEventListener("click",function(){let e="password"===m.type;m.type=e?"text":"password",d.src=e?"https://img.icons8.com/fluency-systems-regular/24/visible--v1.png":"https://img.icons8.com/fluency-systems-regular/24/invisible.png"});let c=document.getElementById("confirm_mot_de_passe"),u=document.getElementById("toggleConfirmPasswordIcon");u.addEventListener("click",function(){let e="password"===c.type;c.type=e?"text":"password",u.src=e?"https://img.icons8.com/fluency-systems-regular/24/visible--v1.png":"https://img.icons8.com/fluency-systems-regular/24/invisible.png"}),document.getElementById("registerForm").addEventListener("submit",function(e){e.preventDefault();let t=document.getElementById("feedback"),n=document.getElementById("password-error");t.textContent="",n.textContent="";let s=document.getElementById("mot_de_passe").value,a=document.getElementById("confirm_mot_de_passe").value,i=document.getElementById("nom_etablissement").value;if(!i){t.className="feedback-error",t.textContent="Veuillez s\xe9lectionner un complexe ET un \xe9tablissement.";return}if(s!==a){n.textContent="Les mots de passe ne correspondent pas.";return}if(s.length<6){n.textContent="Le mot de passe doit contenir au moins 6 caract\xe8res.";return}let r=new FormData(this),l=Object.fromEntries(r.entries());delete l.confirm_mot_de_passe,delete l.email_username,fetch("../api/auth/register.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}).then(e=>e.json()).then(e=>{e.success&&"verify"===e.action?window.location.href=`verify.html?email=${encodeURIComponent(e.email)}`:(t.className="feedback-error",t.textContent=e.message||"Une erreur est survenue.")}).catch(e=>{t.className="feedback-error",t.textContent="Erreur de communication avec le serveur."})})});