let historique=[],selectedWeekIndex=-1,currentView="global",currentMode="formateur",selectedTeacher="",selectedGroup="",teachers=[],groups=new Set;const days=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],slots=["S1","S2","S3","S4"];let selectedDate=new Date,calendarCurrentDate=new Date,currentWeekValue="";function getCacheBuster(){return"t="+new Date().getTime()}function loadData(){fetch("../api/data/get_all_timetables.php").then(e=>e.json()).then(e=>{historique=e.sort((e,t)=>(e.semaine||"").localeCompare(t.semaine||"")),initializeApp()}).catch(e=>{console.error("Erreur de chargement de l'historique:",e),historique=[],initializeApp()})}function initializeApp(){0===historique.length&&console.warn("L'historique des semaines est vide. Le calendrier pourrait ne pas fonctionner comme pr\xe9vu."),setupEventListeners(),setupCustomCalendar(),updateWeekSelection(new Date),updateButtonVisibility()}function setupEventListeners(){document.getElementById("view-toggle-btn").addEventListener("click",toggleView),document.getElementById("print-global-btn").addEventListener("click",()=>window.print()),document.getElementById("tab1").addEventListener("change",()=>switchMode("formateur")),document.getElementById("tab2").addEventListener("change",()=>switchMode("groupe")),setupAutocomplete("teacher"),setupAutocomplete("group"),document.getElementById("download-teacher-pdf").addEventListener("click",()=>downloadPDF("teacher")),document.getElementById("download-group-pdf").addEventListener("click",()=>downloadPDF("group")),document.getElementById("download-global-pdf-btn").addEventListener("click",()=>downloadGlobalPDF(currentMode))}function updateButtonVisibility(){let e="global"===currentView,t="formateur"===currentMode;document.getElementById("global-view-buttons").style.display=e?"flex":"none",document.getElementById("download-teacher-pdf").classList.toggle("hidden",!(!e&&t)),document.getElementById("download-group-pdf").classList.toggle("hidden",!(!e&&!t));let n=document.getElementById("view-toggle-btn");e?n.innerHTML='<i class="fas fa-filter"></i> Vue D\xe9taill\xe9e':n.innerHTML='<i class="fas fa-globe-americas"></i> Vue Globale'}function toggleView(){currentView="global"===currentView?"specific":"global",document.getElementById("global-view-section").classList.toggle("hidden"),document.getElementById("specific-search-section").classList.toggle("hidden"),updateButtonVisibility(),"specific"===currentView?displayDefaultSpecificView():updateAllViews()}function switchMode(e){currentMode=e,document.getElementById("formateur-section").classList.toggle("hidden","formateur"!==e),document.getElementById("groupe-section").classList.toggle("hidden","groupe"!==e),updateButtonVisibility(),"global"===currentView?displayGlobalSchedule():displayDefaultSpecificView()}function updateAllViews(){updateDataForWeek(),"global"===currentView?displayGlobalSchedule():(updateAutocompleteLists(),"formateur"===currentMode&&selectedTeacher&&displayTeacherSchedule(selectedTeacher),"groupe"===currentMode&&selectedGroup&&displayGroupSchedule(selectedGroup))}function updateDataForWeek(){if(-1===selectedWeekIndex){teachers=[],groups.clear();return}let e=historique[selectedWeekIndex]?.emploiDuTemps;if(!e){teachers=[],groups.clear();return}for(let t in teachers=Object.keys(e).sort(),groups.clear(),e)for(let n in e[t])for(let a in e[t][n]){let l=e[t][n][a]?.groupe;l&&l.split(" ").forEach(e=>e.trim()&&groups.add(e.trim()))}}function setupCustomCalendar(){let e=document.getElementById("customWeekDisplay"),t=document.getElementById("calendarPopup"),n=document.getElementById("prevMonthBtn"),a=document.getElementById("nextMonthBtn");e.addEventListener("click",()=>{let e="block"===t.style.display;t.style.display=e?"none":"block",e||generateCalendar(calendarCurrentDate=new Date(selectedDate))}),n.addEventListener("click",()=>{calendarCurrentDate.setMonth(calendarCurrentDate.getMonth()-1),generateCalendar(calendarCurrentDate)}),a.addEventListener("click",()=>{calendarCurrentDate.setMonth(calendarCurrentDate.getMonth()+1),generateCalendar(calendarCurrentDate)}),document.addEventListener("click",n=>{e.closest(".custom-week-picker")||t.closest(".custom-week-picker")||(t.style.display="none")})}function generateCalendar(e){let t=document.getElementById("calendarBody"),n=document.getElementById("calendarTitle");t.innerHTML="";let a=e.getMonth(),l=e.getFullYear(),o=e.toLocaleDateString("fr-FR",{month:"long"});n.textContent=`${o.charAt(0).toUpperCase()+o.slice(1)} ${l}`;let r=new Date(l,a,1),s=new Date(l,a+1,0).getDate(),i=(r.getDay()+6)%7,d=getWeekInfo(selectedDate),{startOfWeek:c,endOfWeek:u}=d,p=1;for(let g=0;g<6;g++){let h=document.createElement("tr");for(let m=0;m<7;m++){let f=document.createElement("td");if(0===g&&m<i);else if(p>s);else{let y=new Date(l,a,p);y.setHours(0,0,0,0);let $=document.createElement("div");$.className="calendar-day",$.textContent=p;let S=new Date;S.setHours(0,0,0,0),y.getTime()===S.getTime()&&$.classList.add("today"),7===y.getMonth()?$.classList.add("disabled-day"):$.onclick=()=>{updateWeekSelection(y),document.getElementById("calendarPopup").style.display="none"},y>=c&&y<=u&&(y.getTime()===c.getTime()?$.classList.add("selected-start"):y.getTime()===u.getTime()?$.classList.add("selected-end"):$.classList.add("selected-in-range")),f.appendChild($),p++}h.appendChild(f)}if(t.appendChild(h),p>s)break}}function updateWeekSelection(e){selectedDate=e;let t=getWeekInfo(e);document.getElementById("weekDisplayText").innerHTML=`<strong>S${t.weekNumber}</strong> <span style="font-size:0.9em; color: #555;">(${t.startOfWeek.toLocaleDateString("fr-FR",{day:"2-digit",month:"short"})} - ${t.endOfWeek.toLocaleDateString("fr-FR",{day:"2-digit",month:"short"})})</span>`,t.weekValue!==currentWeekValue&&(currentWeekValue=t.weekValue,selectedWeekIndex=historique.findIndex(e=>e.semaine===currentWeekValue),updateAllViews()),generateCalendar(calendarCurrentDate)}function getSchoolYear(e){return 8>e.getMonth()?e.getFullYear()-1:e.getFullYear()}function getWeekInfo(e){let t=getSchoolYear(e),n=new Date(t,8,1);n.setDate(n.getDate()+(8-n.getDay())%7),n.getDate()>7&&n.setDate(n.getDate()-7);let a=new Date(e);a.setDate(e.getDate()-(e.getDay()+6)%7),a.setHours(0,0,0,0),n.setHours(0,0,0,0);let l=1;a>=n&&(l=Math.floor((a-n)/6048e5)+1);let o=new Date(a);return o.setDate(a.getDate()+6),{schoolYear:t,weekNumber:l,startOfWeek:a,endOfWeek:o,weekValue:`${t}-W${l}`}}function displayGlobalSchedule(){let e=document.getElementById("global-schedule");if(-1===selectedWeekIndex){e.innerHTML="<thead><tr><th>Aucune donn\xe9e pour cette semaine. S\xe9lectionnez une autre semaine.</th></tr></thead>";return}let t=historique[selectedWeekIndex]?.emploiDuTemps;if(!t){e.innerHTML="<thead><tr><th>Aucune donn\xe9e pour cette semaine</th></tr></thead>";return}let n='<thead><tr><th rowspan="2" colspan="2"></th>';days.forEach((e,t)=>n+=`<th colspan="4">${e}</th>`),n+="</tr><tr>",days.forEach(()=>slots.forEach(e=>n+=`<th>${e}</th>`)),n+="</tr></thead>";let a="<tbody>",l="formateur"===currentMode?teachers:Array.from(groups).sort(),o="formateur"===currentMode?["Groupe","Module","Espace"]:["Formateur","Module","Espace"];l.forEach(e=>{let n={};days.forEach(a=>{slots.forEach(l=>{let o=`${a}-${l}`,r="";"TEAMS"===(r="formateur"===currentMode?t[e]?.[a]?.[l]?.salle||"":findGroupData(t,e,a,l,"salle")||"").toUpperCase()?n[o]="#E6E6FA":"EFM R\xc9G"===r.toUpperCase()&&(n[o]="#ADD8E6")})});for(let l=0;l<o.length;l++)a+=`<tr ${l===o.length-1?'class="salle-row"':""}>`,0===l&&(a+=`<td rowspan="3" class="name-cell">${e}</td>`),a+=`<td class="type-cell">${o[l]}</td>`,days.forEach(r=>{slots.forEach(s=>{let i="",d="espace"===o[l].toLowerCase()?"salle":o[l].toLowerCase();if("formateur"===currentMode)i=t[e]?.[r]?.[s]?.[d]||"";else{let c=findGroupData(t,e,r,s,"all");i=("formateur"===d?c.formateur:c[d])||""}let u=`${r}-${s}`,p=n[u]||"",g=p?`background-color: ${p};`:"";a+=`<td style="${g}">${i}</td>`})}),a+="</tr>"}),e.innerHTML=n+a+"</tbody>"}function findGroupData(e,t,n,a,l){for(let o in e)if(Object.prototype.hasOwnProperty.call(e,o)){let r=e[o]?.[n]?.[a];if(r&&"string"==typeof r.groupe&&r.groupe){let s=r.groupe.trim().split(" ").filter(e=>e);if(s.includes(t))return"all"===l?{formateur:o,...r}:"teacher"===l?o:r[l]||""}}return"all"===l?{}:""}function displayTeacherSchedule(e){let t=document.getElementById("teacher-schedule-table");if(-1===selectedWeekIndex){t.innerHTML='<tbody><tr><td colspan="5">Aucune donn\xe9e disponible.</td></tr></tbody>';return}let n=historique[selectedWeekIndex]?.emploiDuTemps?.[e];if(!n){t.innerHTML='<tbody><tr><td colspan="5">Aucun emploi du temps disponible.</td></tr></tbody>';return}let a="<thead><tr><th>Jour</th><th>Info</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th></tr></thead><tbody>";days.forEach(e=>{let t=n[e]||{};a+=`<tr><td rowspan="3" class="day-header">${e}</td><td class="info-type">Groupe</td><td>${t.S1?.groupe||"-"}</td><td>${t.S2?.groupe||"-"}</td><td>${t.S3?.groupe||"-"}</td><td>${t.S4?.groupe||"-"}</td></tr>
                         <tr><td class="info-type">Module</td><td>${t.S1?.module||"-"}</td><td>${t.S2?.module||"-"}</td><td>${t.S3?.module||"-"}</td><td>${t.S4?.module||"-"}</td></tr>
                         <tr><td class="info-type">Espace</td><td>${t.S1?.salle||"-"}</td><td>${t.S2?.salle||"-"}</td><td>${t.S3?.salle||"-"}</td><td>${t.S4?.salle||"-"}</td></tr>`}),t.innerHTML=a+"</tbody>"}function displayGroupSchedule(e){let t=document.getElementById("group-schedule-table");if(-1===selectedWeekIndex){t.innerHTML='<tbody><tr><td colspan="5">Aucune donn\xe9e disponible.</td></tr></tbody>';return}let n=historique[selectedWeekIndex]?.emploiDuTemps;if(!n){t.innerHTML='<tbody><tr><td colspan="5">Aucune donn\xe9e disponible.</td></tr></tbody>';return}let a="<thead><tr><th>Jour</th><th>Info</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th></tr></thead><tbody>";days.forEach(t=>{a+=`<tr><td rowspan="3" class="day-header">${t}</td><td class="info-type">Formateur</td><td>${findGroupData(n,e,t,"S1","teacher")||"-"}</td><td>${findGroupData(n,e,t,"S2","teacher")||"-"}</td><td>${findGroupData(n,e,t,"S3","teacher")||"-"}</td><td>${findGroupData(n,e,t,"S4","teacher")||"-"}</td></tr>
                         <tr><td class="info-type">Module</td><td>${findGroupData(n,e,t,"S1","module")||"-"}</td><td>${findGroupData(n,e,t,"S2","module")||"-"}</td><td>${findGroupData(n,e,t,"S3","module")||"-"}</td><td>${findGroupData(n,e,t,"S4","module")||"-"}</td></tr>
                         <tr><td class="info-type">Espace</td><td>${findGroupData(n,e,t,"S1","salle")||"-"}</td><td>${findGroupData(n,e,t,"S2","salle")||"-"}</td><td>${findGroupData(n,e,t,"S3","salle")||"-"}</td><td>${findGroupData(n,e,t,"S4","salle")||"-"}</td></tr>`}),t.innerHTML=a+"</tbody>"}function setupAutocomplete(e){let t=document.getElementById(`${e}-search`),n=document.getElementById(`${e}-autocomplete-list`);t.addEventListener("input",()=>{n.style.display="block";let e=t.value.toLowerCase();Array.from(n.children).forEach(t=>t.style.display=t.textContent.toLowerCase().includes(e)?"block":"none")}),document.addEventListener("click",e=>{e.target.closest(".autocomplete-container")||(n.style.display="none")})}function updateAutocompleteLists(){populateAutocomplete("teacher",teachers),populateAutocomplete("group",Array.from(groups).sort())}function populateAutocomplete(e,t){let n=document.getElementById(`${e}-autocomplete-list`);n.innerHTML="",t.forEach(t=>{let a=document.createElement("div");a.className="autocomplete-item",a.textContent=t,a.onclick=()=>{document.getElementById(`${e}-search`).value=t,n.style.display="none","teacher"===e?(selectedTeacher=t,displayTeacherSchedule(t)):(selectedGroup=t,displayGroupSchedule(t))},n.appendChild(a)})}function loadImageAsBase64(e){return new Promise((t,n)=>{let a=new Image;a.crossOrigin="Anonymous",a.onload=()=>{let e=document.createElement("canvas");e.width=a.width,e.height=a.height;let n=e.getContext("2d");n.drawImage(a,0,0);let l=e.toDataURL("image/png");t(l)},a.onerror=t=>n(Error("Failed to load image: "+e)),a.src=e})}async function downloadGlobalPDF(e){let t=document.getElementById("pdf-loading-overlay"),n=document.getElementById("pdf-loading-message"),a=historique[selectedWeekIndex],l=a?.emploiDuTemps;if(!l||0===Object.keys(l).length){alert("Aucune donn\xe9e d'emploi du temps \xe0 exporter pour cette semaine.");return}n.textContent=`G\xe9n\xe9ration du PDF Global (${e})...`,t.style.display="flex";try{let o=await loadImageAsBase64("assets/images/logo_ofppt.png"),{jsPDF:r}=window.jspdf,s=new r({orientation:"landscape",unit:"mm",format:"a2"}),i="formateur"===e?"FORMATEUR":"GROUPE";s.addImage(o,"PNG",15,10,30,30),s.setFontSize(20),s.setFont("helvetica","bold"),s.text(`EMPLOI GLOBAL ${i}S`,s.internal.pageSize.width/2,22,{align:"center"});let{dateDebut:d,dateFin:c}=getDatesForISOWeek(a.semaine),u=formatDate(d);s.setFontSize(16),s.setFont("helvetica","normal"),s.text(`A PARTIR DU : ${u}`,265,38);let p=["08h30 11h00","11h00 13h30","13h30 16h00","16h00 18h30"],g=[[{content:"\xc9MARGEMENT",rowSpan:2,styles:{halign:"center",fontStyle:"bold",fillColor:[255,255,255],textColor:[0,0,0]}},{content:`${i}`,rowSpan:2,styles:{halign:"center",fontStyle:"bold",fillColor:[255,255,255],textColor:[0,0,0]}},{content:"TYPE",rowSpan:2,styles:{halign:"center",fontStyle:"bold",fillColor:[255,255,255],textColor:[0,0,0]}}],[]];days.forEach(e=>{g[0].push({content:e.toUpperCase(),colSpan:4,styles:{halign:"center",fillColor:"#fff",textColor:[0,0,0],fontStyle:"bold"}}),p.forEach(e=>g[1].push({content:e,styles:{halign:"center",fillColor:"#fff",textColor:[0,0,0]}}))});let h=[],m="formateur"===e?teachers:Array.from(groups).sort(),f=["S1","S2","S3","S4"],y="formateur"===e?["Groupe","Module","Salle"]:["Formateur","Module","Salle"];m.forEach(t=>{let n=[[],[],[]];n[0].unshift({content:"",rowSpan:3}),n[0].push({content:t,rowSpan:3,styles:{valign:"middle",fontStyle:"bold"}}),n[0].push({content:y[0].toUpperCase(),styles:{fontStyle:"bold"}}),n[1].push({content:y[1].toUpperCase()}),n[2].push({content:y[2].toUpperCase()}),days.forEach(a=>{f.forEach(o=>{let r={};r="formateur"===e?l[t]?.[a]?.[o]||{}:findGroupData(l,t,a,o,"all")||{};let s=e=>"object"==typeof e&&null!==e?"":e||"",i=s("formateur"===e?r.groupe:r.formateur),d=s(r.module),c=s(r.salle),u=i?{fillColor:[240,240,0]}:{};n[0].push({content:i,styles:u}),n[1].push({content:d,styles:u}),n[2].push({content:c,styles:u})})}),h.push(...n)}),s.autoTable({startY:45,head:g,body:h,theme:"grid",styles:{fontSize:10,cellPadding:2,halign:"center",valign:"middle",lineWidth:.1,lineColor:[0,0,0]},headStyles:{lineWidth:.1,lineColor:[0,0,0],fontStyle:"bold"},columnStyles:{0:{cellWidth:32},1:{cellWidth:28},2:{cellWidth:28,fontStyle:"bold"}},didParseCell(e){0===e.column.index&&e.row.index%3!=0&&(e.cell.text="")}}),s.save(`EDT_GLOBAL_${e.toUpperCase()}_${a.semaine}.pdf`)}catch($){console.error("Erreur PDF Global:",$),alert("Erreur lors de la g\xe9n\xe9ration du PDF Global: "+$.message)}finally{t.style.display="none"}}function getDatesForISOWeek(e){if(!e)return{dateDebut:"",dateFin:""};let[t,n]=e.split("-W").map(Number),a=new Date(t,0,1+(n-1)*7),l=a.getDay(),o=new Date(a);o.setDate(a.getDate()-(0===l?6:l-1)+1);let r=new Date(o);return r.setDate(o.getDate()+5),{dateDebut:o.toISOString().split("T")[0],dateFin:r.toISOString().split("T")[0]}}function formatDate(e){if(!e)return"";let t=new Date(e);if(isNaN(t))return"";let n=String(t.getUTCDate()).padStart(2,"0"),a=String(t.getUTCMonth()+1).padStart(2,"0"),l=t.getUTCFullYear();return`${n}/${a}/${l}`}async function downloadPDF(e){let t=document.getElementById("pdf-loading-overlay"),n=document.getElementById("pdf-loading-message");if("teacher"===e&&!selectedTeacher||"group"===e&&!selectedGroup){alert(`Veuillez s\xe9lectionner un ${"teacher"===e?"formateur":"groupe"}`);return}n.textContent=`G\xe9n\xe9ration du PDF pour le ${e}...`,t.style.display="flex";try{let a=await loadImageAsBase64("assets/images/logo_ofppt.png"),{jsPDF:l}=window.jspdf,o=new l({orientation:"landscape",unit:"mm",format:"a4"});if(o.addImage(a,"png",13,8,22,22),o.setFontSize(11),o.setFont("helvetica","normal"),o.text("Direction : DRCS",14,38),o.text("Complexe/EFP : CFP-BEN M'SIK/ ISTA IBM",14,44),"group"===e){let r=200>selectedGroup.slice(-3)?"1A":"2A";o.text(`Ann\xe9e de formation : ${r}`,14,50)}o.setFontSize(16),o.setFont("helvetica","bold"),o.text(`EMPLOI DU TEMPS ${e.toUpperCase()}`,160,24,{align:"center"}),o.text("Au Titre de l'ann\xe9e 2024-2025",160,31,{align:"center"});let s=0,i={S1:2.5,S2:2.5,S3:2.5,S4:2.5},d=historique[selectedWeekIndex].emploiDuTemps;if("teacher"===e){let c=d[selectedTeacher];for(let u in c)for(let p in c[u])c[u][p]?.groupe&&(s+=i[p]||0);o.setFontSize(16),o.setFont("helvetica","bold"),o.text(`Formateur : ${selectedTeacher}`,250,55,{align:"center"})}else{for(let g in d)for(let h in d[g])for(let m in d[g][h]){let f=d[g][h][m];f.groupe&&f.groupe.split(" ").includes(selectedGroup)&&(s+=i[m]||0)}o.text(`Groupe : ${selectedGroup}`,250,55,{align:"center"})}o.setFontSize(11),o.setFont("helvetica","normal"),o.text(`Masse Horaire : ${Math.round(100*s)/100} H`,14,56);let y=historique[selectedWeekIndex],$=y.semaine.replace("2025-","").replace("W","S"),{dateDebut:S,dateFin:E}=getDatesForISOWeek(y.semaine);o.text(`P\xe9riode d'application: ${$} (${formatDate(S)} - ${formatDate(E)})`,112,56);let b=[{id:"S1",label:"8H30-11H"},{id:"S2",label:"11H-13H30"},{id:"S3",label:"13H30-16H"},{id:"S4",label:"16H-18H30"}],w=[];days.forEach(t=>{let n=[t,"teacher"===e?"Groupe":"Formateur"],a=["","Module"],l=["","Espace"];b.forEach(o=>{let r="",s="",i="";if("teacher"===e){let c=d[selectedTeacher]?.[t]?.[o.id];r=c?.groupe||"",s=c?.module||"",i=c?.salle||""}else for(let u in d){let p=d[u]?.[t]?.[o.id];if(p?.groupe&&p.groupe.split(" ").includes(selectedGroup)){r=u,s=p.module,i=p.salle;break}}n.push(r),a.push(s),l.push(i)}),w.push(n,a,l)});for(let D=0;D<days.length;D++){let _=3*D;for(let I=0;I<b.length;I++){let k=2+I,L=!w[_][k]&&!w[_+1][k]&&!w[_+2][k];L&&(w[_][k]={content:"",rowSpan:3},w[_+1][k]=null,w[_+2][k]=null)}}o.autoTable({startY:65,head:[["","","8H30-11H","11H-13H30","13H30-16H","16H-18H30"]],body:w,theme:"grid"}),o.save(`EDT_${e.toUpperCase()}_${"teacher"===e?selectedTeacher:selectedGroup}_${y.semaine}.pdf`)}catch(C){console.error("Erreur PDF:",C),alert("Erreur lors de la g\xe9n\xe9ration du PDF: "+C.message)}finally{t.style.display="none"}}function displayDefaultSpecificView(){updateDataForWeek(),updateAutocompleteLists();let e=Array.from(groups).sort();"formateur"===currentMode?(document.getElementById("group-schedule-table").innerHTML="",selectedGroup="",document.getElementById("group-search").value="",teachers.length>0?(selectedTeacher=teachers[0],document.getElementById("teacher-search").value=teachers[0],displayTeacherSchedule(teachers[0])):(selectedTeacher="",document.getElementById("teacher-search").value="",document.getElementById("teacher-schedule-table").innerHTML='<tbody><tr><td colspan="6">Aucun formateur disponible.</td></tr></tbody>')):(document.getElementById("teacher-schedule-table").innerHTML="",selectedTeacher="",document.getElementById("teacher-search").value="",e.length>0?(selectedGroup=e[0],document.getElementById("group-search").value=e[0],displayGroupSchedule(e[0])):(selectedGroup="",document.getElementById("group-search").value="",document.getElementById("group-schedule-table").innerHTML='<tbody><tr><td colspan="6">Aucun groupe disponible.</td></tr></tbody>'))}const voiceAssistantBtn=document.getElementById("voiceAssistantBtn"),assistantStatus=document.getElementById("assistantStatus"),SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;let recognition;function setupVoiceAssistant(){voiceAssistantBtn.addEventListener("click",toggleListening),recognition.onresult=e=>{let t=e.results[e.results.length-1][0].transcript.trim();updateStatus(`J'ai entendu : "${t}"`),processCommand(t)},recognition.onerror=()=>{updateStatus("D\xe9sol\xe9, je n'ai pas compris.",3e3,!0),stopListening()},recognition.onend=()=>stopListening()}function toggleListening(){voiceAssistantBtn.classList.contains("listening")?recognition.stop():startListening()}function startListening(){voiceAssistantBtn.classList.add("listening"),voiceAssistantBtn.querySelector("span i").className="fas fa-wave-square",updateStatus("Je vous \xe9coute...",0),recognition.start()}function stopListening(){voiceAssistantBtn.classList.remove("listening"),voiceAssistantBtn.querySelector("span i").className="fas fa-microphone",setTimeout(()=>assistantStatus.classList.remove("visible"),500)}function updateStatus(e,t=2e3,n=!1){assistantStatus.textContent=e,assistantStatus.style.backgroundColor=n?"#e74c3c":"rgba(0, 0, 0, 0.75)",assistantStatus.classList.add("visible"),t>0&&setTimeout(()=>assistantStatus.classList.remove("visible"),t)}function speak(e){speechSynthesis.cancel();let t=new SpeechSynthesisUtterance(e);t.lang="fr-FR",t.rate=1.1,speechSynthesis.speak(t)}async function processCommand(e){updateStatus("Analyse en cours...",0);let t=`
                Tu es un assistant pour une page d'\xe9dition d'emplois du temps. Convertis la requ\xeate en JSON.
                Contexte: Formateurs valides: ${teachers.map(e=>e.toUpperCase()).join(", ")}. Groupes valides: ${Array.from(groups).map(e=>e.toUpperCase()).join(", ")}.
                Intents: 'telecharger_pdf', 'changer_vue', 'changer_mode', 'selectionner_semaine', 'naviguer_page', 'inconnue'.
                Format de r\xe9ponse JSON OBLIGATOIRE: {"intent": "...", "parameters": {"cible": "...", "nom": "...", "vue": "...", "mode": "...", "semaine": ..., "page": "..."}, "response": "..."}
                Exemples:
                - "T\xe9l\xe9charge le PDF pour Dupont" -> {"intent": "telecharger_pdf", "parameters": {"cible": "formateur", "nom": "DUPONT"}, "response": "Je pr\xe9pare le PDF pour Dupont."}
                - "Exporte le global des groupes" -> {"intent": "telecharger_pdf", "parameters": {"cible": "global", "mode": "groupe"}, "response": "PDF global pour les groupes en cours."}
                Analyse: "${e}"
            `;try{let n=await fetch("../api/data/gemini_proxy.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t})});if(!n.ok)throw Error("R\xe9ponse du proxy non valide.");let a=await n.json(),l=a.candidates[0].content.parts[0].text,o=JSON.parse(l.replace(/```json|```/g,"").trim());switch(speak(o.response),o.intent){case"telecharger_pdf":handleDownloadCommand(o.parameters);break;case"changer_vue":("detaillee"===o.parameters.vue&&"global"===currentView||"globale"===o.parameters.vue&&"specific"===currentView)&&toggleView();break;case"changer_mode":"formateur"===o.parameters.mode?document.getElementById("tab1").click():"groupe"===o.parameters.mode&&document.getElementById("tab2").click();break;case"selectionner_semaine":if(o.parameters.semaine){let r=getSchoolYear(new Date),s=getWeekInfo(new Date(r,8,1)).startOfWeek,i=new Date(s);i.setDate(s.getDate()+(o.parameters.semaine-1)*7),updateWeekSelection(i)}break;case"naviguer_page":let d={accueil:"emploi.html",edition:"edition.html",avancement:"avancement.html",espaces:"espaces.html"};o.parameters.page&&d[o.parameters.page]&&(window.location.href=d[o.parameters.page])}}catch(c){console.error("Erreur Gemini:",c),speak("D\xe9sol\xe9, une erreur est survenue."),updateStatus("Erreur de communication",4e3,!0)}}function handleDownloadCommand(e){let{cible:t,nom:n,mode:a}=e;if("global"===t)a&&a!==currentMode&&switchMode(a),"global"!==currentView&&toggleView(),setTimeout(()=>document.getElementById("download-global-pdf-btn").click(),300);else if("formateur"===t||"groupe"===t){if(!n){speak("Veuillez sp\xe9cifier un nom.");return}"specific"!==currentView&&toggleView(),switchMode(t),setTimeout(()=>{let e=document.getElementById(`${t}-search`),a=document.getElementById(`${t}-autocomplete-list`);e.value=n;let l=Array.from(a.children).find(e=>e.textContent.toUpperCase()===n.toUpperCase());l?(l.click(),setTimeout(()=>document.getElementById(`download-${t}-pdf`).click(),500)):speak(`D\xe9sol\xe9, je ne trouve pas le ${t} nomm\xe9 ${n}.`)},500)}}function getInitials(e){if(!e)return"--";let t=e.trim().split(" ");return 1===t.length?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function populateUserInfo(e){e&&(document.getElementById("profile-initials").textContent=getInitials(e.nom),document.getElementById("dropdown-user-name").textContent=e.nom,document.getElementById("dropdown-user-email").textContent=e.email)}function setupProfileMenu(){let e=document.getElementById("profile-button"),t=document.getElementById("profile-dropdown");e&&t&&(e.addEventListener("click",e=>{e.stopPropagation(),t.classList.toggle("show")}),window.addEventListener("click",e=>{t.classList.contains("show")&&!t.contains(e.target)&&t.classList.remove("show")}))}async function checkSessionAndLoad(){try{let e=await fetch("../api/auth/verify_session.php"),t=await e.json();if(!t.success){window.location.href="login.html";return}populateUserInfo(t.userData),setupProfileMenu(),loadData()}catch(n){console.error("Session check failed:",n),window.location.href="login.html"}}SpeechRecognition?((recognition=new SpeechRecognition).continuous=!1,recognition.lang="fr-FR",recognition.interimResults=!1,setupVoiceAssistant()):voiceAssistantBtn.style.display="none",document.addEventListener("DOMContentLoaded",checkSessionAndLoad);